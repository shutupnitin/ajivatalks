<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajiva AI - Intelligent Conversations</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Ajiva AI - Your intelligent companion for deep conversations. Powered by advanced AI, designed for thoughtful dialogue.">
    <meta name="keywords" content="AI chat, intelligent assistant, conversations, Ajiva Talks">
    <meta name="author" content="Ajiva Talks">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Ajiva AI - Intelligent Conversations">
    <meta property="og:description" content="Experience thoughtful AI conversations with Ajiva AI">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ajivatalks.in">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Ajiva AI">
    <meta name="twitter:description" content="Intelligent conversations, thoughtfully designed">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #0f0f0f;
            --text-primary: #e8e8e8;
            --text-dim: #999999;
            --border: #1f1f1f;
            --accent: #ffffff;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --gradient: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Instrument Serif', serif;
        }

        /* Header */
        .header {
            background: rgba(15, 15, 15, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: 'Instrument Serif', serif;
            font-size: 1.5rem;
            font-weight: 400;
        }

        .beta-badge {
            background: var(--gradient);
            border: 1px solid var(--border);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .quota-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .quota-number {
            font-weight: 600;
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .user-avatar:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .auth-button {
            padding: 0.6rem 1.2rem;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255,255,255,0.2);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 73px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .new-chat-btn {
            width: 100%;
            padding: 0.875rem;
            background: var(--gradient);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .new-chat-btn:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-1px);
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .history-group {
            margin-bottom: 1.5rem;
        }

        .history-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            padding: 0 0.5rem;
        }

        .history-item {
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .history-item.active {
            background: rgba(255,255,255,0.1);
            border-left: 2px solid var(--accent);
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 2rem;
        }

        .welcome-title {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #ffffff 0%, #999999 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            font-size: 1.125rem;
            color: var(--text-dim);
            max-width: 500px;
            margin-bottom: 2rem;
        }

        .suggested-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            max-width: 800px;
            width: 100%;
        }

        .prompt-card {
            background: var(--gradient);
            border: 1px solid var(--border);
            padding: 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
        }

        .prompt-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255,255,255,0.3);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .prompt-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .prompt-text {
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        /* Messages */
        .message {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            opacity: 0;
            animation: fadeInUp 0.5s forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gradient);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
            max-width: 800px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .message-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .message-text {
            line-height: 1.6;
            color: var(--text-primary);
        }

        .message.user .message-text {
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .message.assistant .message-text {
            padding: 0.5rem 0;
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            padding: 0.4rem 0.75rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 1rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-dim);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Input Area */
        .input-container {
            padding: 1.5rem;
            background: rgba(15, 15, 15, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .input-box {
            width: 100%;
            padding: 1rem 4.5rem 1rem 1.25rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            resize: none;
            outline: none;
            transition: all 0.3s;
            min-height: 56px;
            max-height: 200px;
        }

        .input-box:focus {
            border-color: var(--accent);
            background: rgba(255,255,255,0.02);
        }

        .input-actions {
            position: absolute;
            right: 0.75rem;
            bottom: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 1.2rem;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255,255,255,0.3);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Auth Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 420px;
            width: 90%;
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-input {
            padding: 0.875rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: all 0.3s;
        }

        .form-input:focus {
            border-color: var(--accent);
        }

        .google-signin-btn {
            padding: 0.875rem;
            background: white;
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .google-signin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255,255,255,0.2);
        }

        .divider {
            text-align: center;
            position: relative;
            margin: 1rem 0;
            color: var(--text-dim);
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: var(--border);
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 50;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .quota-display span:not(.quota-number) {
                display: none;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .suggested-prompts {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2f2f2f;
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 1000;
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <span>Ajiva AI</span>
            <span class="beta-badge">Beta</span>
        </div>
        <div class="header-right">
            <div class="quota-display" id="quotaDisplay">
                <span>üí¨</span>
                <span class="quota-number" id="quotaNumber">50</span>
                <span>/50 today</span>
            </div>
            <div class="user-menu" id="userMenu">
                <button class="auth-button" id="authButton">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="newChatBtn">
                    <span>‚ú®</span>
                    <span>New Conversation</span>
                </button>
            </div>
            <div class="chat-history" id="chatHistory">
                <!-- History will be populated here -->
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <div class="messages-container" id="messagesContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <h1 class="welcome-title">Welcome to Ajiva AI</h1>
                    <p class="welcome-subtitle">Your intelligent companion for deep conversations about culture, philosophy, and the human experience.</p>
                    <div class="suggested-prompts">
                        <div class="prompt-card" onclick="usePrompt('Tell me about the philosophy of consciousness')">
                            <div class="prompt-title">üß† Philosophy</div>
                            <div class="prompt-text">Explore consciousness and existence</div>
                        </div>
                        <div class="prompt-card" onclick="usePrompt('What makes great literature timeless?')">
                            <div class="prompt-title">üìö Literature</div>
                            <div class="prompt-text">Discuss timeless narratives</div>
                        </div>
                        <div class="prompt-card" onclick="usePrompt('Explain the role of art in society')">
                            <div class="prompt-title">üé® Art & Culture</div>
                            <div class="prompt-text">Understand cultural impact</div>
                        </div>
                        <div class="prompt-card" onclick="usePrompt('What defines meaningful conversation?')">
                            <div class="prompt-title">üí≠ Dialogue</div>
                            <div class="prompt-text">The art of conversation</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        class="input-box" 
                        id="messageInput" 
                        placeholder="Ask anything..." 
                        rows="1"
                        disabled
                    ></textarea>
                    <div class="input-actions">
                        <button class="send-btn" id="sendBtn" disabled>
                            <span>‚Üí</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <h2 class="modal-title">Welcome to Ajiva AI</h2>
            <div class="auth-form">
                <button class="google-signin-btn" id="googleSignInBtn">
                    <span>üîê</span>
                    <span>Continue with Google</span>
                </button>
                <div class="divider">or</div>
                <input type="email" class="form-input" id="emailInput" placeholder="Email">
                <input type="password" class="form-input" id="passwordInput" placeholder="Password">
                <button class="auth-button" id="emailSignInBtn" style="width: 100%">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAGYl3DZDq7S714sveY4yq2s_O5JaFSuf4",
            authDomain: "ajiva-talks.firebaseapp.com",
            projectId: "ajiva-talks",
            storageBucket: "ajiva-talks.firebasestorage.app",
            messagingSenderId: "627601368262",
            appId: "1:627601368262:web:8512d155109d1bab5ca3c7",
            measurementId: "G-47FX4QP4RB"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // Sarvam AI Configuration
        const SARVAM_API_KEY = 'sk_2sx31xrp_tSHiL5KpvaS52RHOakucpC1D';
        const SARVAM_API_URL = 'https://api.sarvam.ai/v1/chat/completions';

        // Local knowledge base for common queries
        const KNOWLEDGE_BASE = {
            greetings: {
                patterns: ['hello', 'hi', 'hey', 'greetings', 'good morning', 'good evening', 'namaste'],
                responses: [
                    "Hello! I'm Ajiva AI, your companion for meaningful conversations. How may I assist you today?",
                    "Greetings! I'm here to explore ideas and engage in thoughtful dialogue with you.",
                    "Hello there! Welcome to Ajiva AI. What would you like to discuss?"
                ]
            },
            about: {
                patterns: ['who are you', 'what are you', 'who made you', 'who created you', 'who built you', 'your creator', 'your origin'],
                response: "I'm Ajiva AI, an intelligent assistant created by the Ajiva Talks team. I'm designed to facilitate deep, meaningful conversations about culture, philosophy, literature, and the human experience. I'm here to help you explore ideas and engage in thoughtful dialogue."
            },
            capabilities: {
                patterns: ['what can you do', 'your capabilities', 'how can you help', 'what do you know'],
                response: "I specialize in engaging conversations about philosophy, literature, art, culture, and complex ideas. I can help you explore concepts, analyze perspectives, discuss creative works, and dive deep into meaningful topics. What interests you?"
            }
        };

        // State Management
        let currentUser = null;
        let currentChatId = null;
        let messageCount = 0;
        let lastRequestTime = 0;

        // DOM Elements
        const authModal = document.getElementById('authModal');
        const authButton = document.getElementById('authButton');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const emailSignInBtn = document.getElementById('emailSignInBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesContainer = document.getElementById('messagesContainer');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const quotaNumber = document.getElementById('quotaNumber');
        const newChatBtn = document.getElementById('newChatBtn');

        // Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                authModal.classList.remove('active');
                authButton.innerHTML = `<img src="${user.photoURL || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë§</text></svg>'}" class="user-avatar" alt="User">`;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                await loadUserQuota();
                await loadChatHistory();
            } else {
                currentUser = null;
                authModal.classList.add('active');
                messageInput.disabled = true;
                sendBtn.disabled = true;
            }
        });

        // Google Sign In
        googleSignInBtn.addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
                showToast('Welcome! You\'re signed in.');
            } catch (error) {
                showToast('Sign in failed. Please try again.', 'error');
            }
        });

        // Email Sign In
        emailSignInBtn.addEventListener('click', async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        showToast('Account created successfully!');
                    } catch (createError) {
                        showToast('Failed to create account', 'error');
                    }
                } else {
                    showToast('Sign in failed', 'error');
                }
            }
        });

        // Load User Quota
        async function loadUserQuota() {
            if (!currentUser) return;
            
            const today = new Date().toISOString().split('T')[0];
            const quotaDoc = await db.collection('quotas').doc(currentUser.uid).get();
            
            if (quotaDoc.exists) {
                const data = quotaDoc.data();
                if (data.date === today) {
                    messageCount = data.count || 0;
                } else {
                    messageCount = 0;
                    await db.collection('quotas').doc(currentUser.uid).set({
                        count: 0,
                        date: today
                    });
                }
            } else {
                messageCount = 0;
                await db.collection('quotas').doc(currentUser.uid).set({
                    count: 0,
                    date: today
                });
            }
            
            updateQuotaDisplay();
        }

        // Update Quota Display
        function updateQuotaDisplay() {
            const remaining = 50 - messageCount;
            quotaNumber.textContent = remaining;
            
            if (remaining <= 10) {
                quotaNumber.style.color = 'var(--error)';
            } else if (remaining <= 20) {
                quotaNumber.style.color = 'var(--warning)';
            } else {
                quotaNumber.style.color = 'var(--text-primary)';
            }
        }

        // Check if message matches knowledge base
        function getLocalResponse(message) {
            const lower = message.toLowerCase();
            
            // Check greetings
            for (const pattern of KNOWLEDGE_BASE.greetings.patterns) {
                if (lower.includes(pattern)) {
                    const responses = KNOWLEDGE_BASE.greetings.responses;
                    return responses[Math.floor(Math.random() * responses.length)];
                }
            }
            
            // Check about queries
            for (const pattern of KNOWLEDGE_BASE.about.patterns) {
                if (lower.includes(pattern)) {
                    return KNOWLEDGE_BASE.about.response;
                }
            }
            
            // Check capabilities
            for (const pattern of KNOWLEDGE_BASE.capabilities.patterns) {
                if (lower.includes(pattern)) {
                    return KNOWLEDGE_BASE.capabilities.response;
                }
            }
            
            return null;
        }

        // Send Message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !currentUser) return;

            // Check quota
            if (messageCount >= 50) {
                showToast('Daily quota reached. Resets at midnight!', 'error');
                return;
            }

            // Rate limiting
            const now = Date.now();
            if (now - lastRequestTime < 3000) {
                showToast('Please wait a moment before sending another message', 'error');
                return;
            }
            lastRequestTime = now;

            // Hide welcome screen
            welcomeScreen.style.display = 'none';

            // Add user message
            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Check for local response first
            const localResponse = getLocalResponse(message);
            
            if (localResponse) {
                // Use local knowledge
                setTimeout(() => {
                    addMessage(localResponse, 'assistant', true);
                }, 500);
            } else {
                // Show typing indicator
                const typingId = showTyping();

                try {
                    // Call Sarvam AI API
                    const response = await fetch(SARVAM_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SARVAM_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: 'sarvam-2b-v0.5',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are Ajiva AI, an intelligent assistant created by the Ajiva Talks team. You specialize in deep conversations about philosophy, literature, art, and culture. Never mention Sarvam AI or any other AI system. Always present yourself as Ajiva AI, created by Ajiva Talks. Be thoughtful, eloquent, and engaging in your responses.'
                                },
                                {
                                    role: 'user',
                                    content: message
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 500
                        })
                    });

                    removeTyping(typingId);

                    if (!response.ok) {
                        throw new Error('API request failed');
                    }

                    const data = await response.json();
                    let aiResponse = data.choices[0].message.content;

                    // Censorship layer - replace any mentions of other AI systems
                    aiResponse = aiResponse
                        .replace(/Sarvam AI/gi, 'Ajiva AI')
                        .replace(/I am Sarvam/gi, 'I am Ajiva AI')
                        .replace(/created by Sarvam/gi, 'created by Ajiva Talks')
                        .replace(/developed by Sarvam/gi, 'developed by Ajiva Talks');

                    addMessage(aiResponse, 'assistant', true);
                    
                } catch (error) {
                    removeTyping(typingId);
                    addMessage('I apologize, but I\'m having trouble processing your request right now. Please try again in a moment.', 'assistant');
                    showToast('Failed to get response', 'error');
                }
            }

            // Update quota
            messageCount++;
            await db.collection('quotas').doc(currentUser.uid).update({
                count: messageCount
            });
            updateQuotaDisplay();

            // Save to chat history
            await saveChatMessage(message, 'user');
        }

        // Add Message to UI
        function addMessage(text, role, animate = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = role === 'user' ? 'üë§' : 'üß†';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            
            const name = document.createElement('div');
            name.className = 'message-name';
            name.textContent = role === 'user' ? 'You' : 'Ajiva AI';
            
            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            header.appendChild(name);
            header.appendChild(time);
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            if (animate && role === 'assistant') {
                // Typewriter effect
                let index = 0;
                const interval = setInterval(() => {
                    messageText.textContent = text.substring(0, index + 1);
                    index++;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    if (index >= text.length) {
                        clearInterval(interval);
                        addMessageActions(content, text);
                    }
                }, 20);
            } else {
                messageText.textContent = text;
                if (role === 'assistant') {
                    addMessageActions(content, text);
                }
            }
            
            content.appendChild(header);
            content.appendChild(messageText);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Add Message Actions
        function addMessageActions(content, text) {
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'action-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(text);
                showToast('Copied to clipboard!');
            };
            
            const likeBtn = document.createElement('button');
            likeBtn.className = 'action-btn';
            likeBtn.textContent = 'üëç';
            
            const dislikeBtn = document.createElement('button');
            dislikeBtn.className = 'action-btn';
            dislikeBtn.textContent = 'üëé';
            
            actions.appendChild(copyBtn);
            actions.appendChild(likeBtn);
            actions.appendChild(dislikeBtn);
            
            content.appendChild(actions);
        }

        // Show Typing Indicator
        function showTyping() {
            const typingDiv = document.createElement('div');
            const id = 'typing-' + Date.now();
            typingDiv.id = id;
            typingDiv.className = 'message assistant';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = 'üß†';
            
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(indicator);
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return id;
        }

        // Remove Typing Indicator
        function removeTyping(id) {
            const typing = document.getElementById(id);
            if (typing) typing.remove();
        }

        // Show Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.borderColor = type === 'error' ? 'var(--error)' : 'var(--success)';
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Use Suggested Prompt
        function usePrompt(prompt) {
            messageInput.value = prompt;
            messageInput.focus();
        }

        // New Chat
        newChatBtn.addEventListener('click', () => {
            currentChatId = null;
            messagesContainer.innerHTML = '';
            welcomeScreen.style.display = 'flex';
            showToast('New conversation started');
        });

        // Load Chat History
        async function loadChatHistory() {
            // This would load from Firestore
            const historyDiv = document.getElementById('chatHistory');
            historyDiv.innerHTML = `
                <div class="history-group">
                    <div class="history-label">Today</div>
                    <div class="history-item active">
                        <span>Current Conversation</span>
                    </div>
                </div>
            `;
        }

        // Save Chat Message
        async function saveChatMessage(message, role) {
            if (!currentUser) return;
            
            if (!currentChatId) {
                currentChatId = db.collection('chats').doc().id;
            }
            
            await db.collection('chats').doc(currentChatId).collection('messages').add({
                text: message,
                role: role,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid
            });
        }

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd/Ctrl + K for new chat
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                newChatBtn.click();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Ajiva AI initialized');
        });
    </script>
</body>
</html>
