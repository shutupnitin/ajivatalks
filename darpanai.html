<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Darpan - Intelligent Conversations | Ajiva Talks</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Darpan by Ajiva Talks - Your intelligent companion for deep conversations about philosophy, culture, and ideas.">
    <meta name="keywords" content="AI chat, Darpan, Ajiva Talks, intelligent assistant, conversations">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Darpan - Intelligent Conversations">
    <meta property="og:description" content="Experience thoughtful AI conversations with Darpan by Ajiva Talks">
    <meta property="og:type" content="website">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #0f0f0f;
            --bg-tertiary: #141414;
            --text-primary: #e8e8e8;
            --text-secondary: #999999;
            --border-primary: #1f1f1f;
            --border-secondary: #2a2a2a;
            --accent: #ffffff;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --blue: #3b82f6;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header */
        .header {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-primary);
            padding: 0.875rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            height: 60px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-toggle {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .menu-toggle:hover {
            background: var(--bg-secondary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .logo-img {
            height: 24px;
            width: auto;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .quota-badge {
            padding: 0.5rem 0.875rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--success);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 1.5px solid var(--border-secondary);
            transition: all 0.2s;
            position: relative;
        }

        .user-avatar:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .user-menu {
            position: absolute;
            top: 50px;
            right: 1.25rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 0.5rem;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }

        .user-menu.active {
            display: block;
        }

        .user-menu-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
        }

        .user-menu-item:hover {
            background: var(--bg-tertiary);
        }

        .user-menu-item.danger {
            color: var(--error);
        }

        .auth-btn {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .auth-btn:hover {
            opacity: 0.9;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            height: calc(100dvh - 60px);
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }

        .new-chat-btn {
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .new-chat-btn:hover {
            background: var(--bg-secondary);
        }

        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .chat-item {
            padding: 0.625rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .chat-item.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .chat-item-delete {
            opacity: 0;
            background: transparent;
            border: none;
            color: var(--error);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .chat-item:hover .chat-item-delete {
            opacity: 1;
        }

        .chat-item-delete:hover {
            background: var(--bg-tertiary);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .messages-container {
            max-width: 48rem;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 200px);
            text-align: center;
            padding: 2rem 1rem;
        }

        .welcome-icon {
            width: 100px;
            height: 100px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .welcome-title {
            font-family: 'Instrument Serif', serif;
            font-size: 2rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .welcome-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            max-width: 500px;
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.75rem;
            max-width: 800px;
            width: 100%;
        }

        .prompt-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .prompt-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-secondary);
        }

        .prompt-card-title {
            font-weight: 600;
            margin-bottom: 0.375rem;
            font-size: 0.875rem;
        }

        .prompt-card-text {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1rem;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-text {
            line-height: 1.6;
            color: var(--text-primary);
            font-size: 0.9375rem;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-text.editing {
            display: none;
        }

        .message-edit-input {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            resize: vertical;
            min-height: 80px;
            display: none;
        }

        .message-edit-input.active {
            display: block;
        }

        .message-edit-actions {
            display: none;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .message-edit-actions.active {
            display: flex;
        }

        .message-text strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-text em {
            font-style: italic;
        }

        .message-text code {
            background: var(--bg-tertiary);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .message-text pre {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5rem 0;
            border: 1px solid var(--border-primary);
        }

        .message-text pre code {
            background: transparent;
            padding: 0;
            border: none;
            font-size: 0.875rem;
            display: block;
            white-space: pre;
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.625rem;
            opacity: 0;
            transition: opacity 0.2s;
            flex-wrap: wrap;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            padding: 0.375rem 0.625rem;
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .action-btn.primary {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .action-btn.danger {
            color: var(--error);
            border-color: var(--error);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 0;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-6px); }
        }

        /* Input Area */
        .input-area {
            border-top: 1px solid var(--border-primary);
            padding: 1rem;
            background: var(--bg-primary);
        }

        .input-wrapper {
            max-width: 48rem;
            margin: 0 auto;
            position: relative;
        }

        .input-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            transition: all 0.2s;
        }

        .input-container:focus-within {
            border-color: var(--border-secondary);
            background: var(--bg-tertiary);
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            resize: none;
            max-height: 200px;
            line-height: 1.5;
        }

        .message-input::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            width: 32px;
            height: 32px;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Quote Generator Modal */
        .quote-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .quote-modal.active {
            display: flex;
        }

        .quote-canvas-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
        }

        .quote-canvas {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .quote-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }

        /* Auth Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-family: 'Instrument Serif', serif;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-input {
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--border-secondary);
        }

        .google-btn {
            padding: 0.75rem;
            background: white;
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .google-btn:hover {
            opacity: 0.9;
        }

        .divider {
            text-align: center;
            position: relative;
            margin: 0.5rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 43%;
            height: 1px;
            background: var(--border-primary);
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 0.875rem 1.25rem;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
            font-size: 0.875rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3a3a3a;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 60px;
                height: calc(100vh - 60px);
                z-index: 90;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
            }

            .example-prompts {
                grid-template-columns: 1fr;
            }

            .welcome-title {
                font-size: 1.5rem;
            }

            .messages-container {
                padding: 1rem 0.75rem;
            }

            .message {
                gap: 0.75rem;
            }
        }

        @media (max-width: 640px) {
            .header {
                padding: 0.75rem 1rem;
            }

            .input-area {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <div class="logo">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 500 500'%3E%3Crect fill='%23f5f5dc' width='500' height='500'/%3E%3Ctext x='250' y='320' font-family='Arial, sans-serif' font-size='120' font-weight='500' text-anchor='middle' fill='%23000'%3Edarpan%3C/text%3E%3C/svg%3E" alt="Darpan" class="logo-img">
            </div>
        </div>
        <div class="header-right">
            <div class="quota-badge">
                <span>‚ú®</span>
                <span>Unlimited</span>
            </div>
            <div id="userSection">
                <button class="auth-btn" id="authBtn">Sign In</button>
            </div>
        </div>
    </div>

    <!-- User Menu -->
    <div class="user-menu" id="userMenu">
        <div class="user-menu-item" id="signOutBtn">
            <span>üö™</span>
            <span>Sign Out</span>
        </div>
    </div>

    <!-- Main -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar hidden" id="sidebar">
            <div class="sidebar-content">
                <button class="new-chat-btn" id="newChatBtn">
                    <span>+</span>
                    <span>New chat</span>
                </button>
                <div class="chat-list" id="chatList">
                    <!-- Chats will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-container">
            <div class="messages-wrapper" id="messagesWrapper">
                <div class="messages-container" id="messagesContainer">
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 500 500'%3E%3Crect fill='%23f5f5dc' width='500' height='500'/%3E%3Ctext x='250' y='320' font-family='Arial, sans-serif' font-size='120' font-weight='500' text-anchor='middle' fill='%23000'%3Edarpan%3C/text%3E%3C/svg%3E" alt="Darpan" style="width: 100px; height: auto; border-radius: 12px;">
                        </div>
                        <h1 class="welcome-title">Welcome to Darpan</h1>
                        <p class="welcome-subtitle">Your intelligent companion for deep conversations about philosophy, culture, and the human experience. Created by Ajiva Talks.</p>
                        <div class="example-prompts">
                            <div class="prompt-card" onclick="usePrompt('Tell me about the philosophy of consciousness')">
                                <div class="prompt-card-title">Philosophy</div>
                                <div class="prompt-card-text">Explore consciousness and existence</div>
                            </div>
                            <div class="prompt-card" onclick="usePrompt('What makes literature timeless?')">
                                <div class="prompt-card-title">Literature</div>
                                <div class="prompt-card-text">Discuss great narratives</div>
                            </div>
                            <div class="prompt-card" onclick="usePrompt('Explain the role of art in society')">
                                <div class="prompt-card-title">Culture</div>
                                <div class="prompt-card-text">Understand cultural impact</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input -->
            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-container">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="Message Darpan..." 
                            rows="1"
                            disabled
                        ></textarea>
                        <button class="send-btn" id="sendBtn" disabled>‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <h2 class="modal-title">Sign in to Darpan</h2>
            <div class="auth-form">
                <button class="google-btn" id="googleBtn">
                    <span>üîê</span>
                    <span>Continue with Google</span>
                </button>
                <div class="divider">or</div>
                <input type="email" class="form-input" id="emailInput" placeholder="Email">
                <input type="password" class="form-input" id="passwordInput" placeholder="Password">
                <button class="auth-btn" id="emailAuthBtn" style="width: 100%">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Quote Generator Modal -->
    <div class="quote-modal" id="quoteModal">
        <div class="quote-canvas-container">
            <canvas id="quoteCanvas" class="quote-canvas" width="1080" height="1920"></canvas>
            <div class="quote-actions">
                <button class="action-btn primary" id="downloadQuoteBtn">Download</button>
                <button class="action-btn" id="closeQuoteBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAGYl3DZDq7S714sveY4yq2s_O5JaFSuf4",
            authDomain: "ajiva-talks.firebaseapp.com",
            projectId: "ajiva-talks",
            storageBucket: "ajiva-talks.firebasestorage.app",
            messagingSenderId: "627601368262",
            appId: "1:627601368262:web:8512d155109d1bab5ca3c7"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // API Config
        const SARVAM_API_KEY = 'sk_2sx31xrp_tSHiL5KpvaS52RHOakucpC1D';
        const SARVAM_URL = 'https://api.sarvam.ai/v1/chat/completions';

        // Knowledge Base
        const KNOWLEDGE_BASE = {
            greetings: {
                patterns: ['hello', 'hi', 'hey', 'namaste', 'good morning', 'good evening', 'good afternoon'],
                responses: [
                    "Hello! I'm Darpan, your companion for meaningful conversations. How may I assist you today?",
                    "Greetings! I'm here to explore ideas and engage in thoughtful dialogue with you.",
                    "Hello! Welcome to Darpan. What would you like to discuss?"
                ]
            },
            identity: {
                patterns: ['who are you', 'what are you', 'who made you', 'who created you', 'your creator', 'your origin', 'built you', 'developed you'],
                response: "I'm Darpan, an intelligent AI assistant created by the Ajiva Talks team. My purpose is to facilitate deep, meaningful conversations about philosophy, culture, literature, and the human experience. I'm here to help you explore complex ideas through thoughtful dialogue."
            },
            capabilities: {
                patterns: ['what can you do', 'your capabilities', 'how can you help', 'what do you know'],
                response: "I specialize in engaging conversations about philosophy, literature, art, culture, and complex ideas. I can help you explore concepts, analyze perspectives, discuss creative works, and dive deep into meaningful topics. What interests you?"
            },
            thanks: {
                patterns: ['thank you', 'thanks', 'appreciate'],
                responses: ["You're welcome! Happy to help.", "My pleasure! Let me know if you need anything else.", "Glad I could assist!"]
            }
        };

        // State
        let currentUser = null;
        let currentChatId = null;
        let conversationHistory = [];
        let lastRequestTime = 0;
        let messageElements = new Map(); // Track message elements for editing

        // DOM
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const authModal = document.getElementById('authModal');
        const authBtn = document.getElementById('authBtn');
        const googleBtn = document.getElementById('googleBtn');
        const emailAuthBtn = document.getElementById('emailAuthBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesContainer = document.getElementById('messagesContainer');
        const messagesWrapper = document.getElementById('messagesWrapper');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const newChatBtn = document.getElementById('newChatBtn');
        const chatList = document.getElementById('chatList');
        const userMenu = document.getElementById('userMenu');
        const signOutBtn = document.getElementById('signOutBtn');
        const quoteModal = document.getElementById('quoteModal');
        const quoteCanvas = document.getElementById('quoteCanvas');
        const downloadQuoteBtn = document.getElementById('downloadQuoteBtn');
        const closeQuoteBtn = document.getElementById('closeQuoteBtn');

        // Toggle Sidebar
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
        });

        // User Menu Toggle
        document.addEventListener('click', (e) => {
            const userAvatar = document.querySelector('.user-avatar');
            if (userAvatar && userAvatar.contains(e.target)) {
                userMenu.classList.toggle('active');
            } else if (!userMenu.contains(e.target)) {
                userMenu.classList.remove('active');
            }
        });

        // Sign Out
        signOutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                currentChatId = null;
                conversationHistory = [];
                messagesContainer.innerHTML = '';
                welcomeScreen.style.display = 'flex';
                chatList.innerHTML = '';
                userMenu.classList.remove('active');
                showToast('Signed out successfully');
            } catch (error) {
                showToast('Sign out failed', 'error');
            }
        });

        // Auth State
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                authModal.classList.remove('active');
                document.getElementById('userSection').innerHTML = `
                    <img src="${user.photoURL || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë§</text></svg>'}" 
                         class="user-avatar" alt="User">
                `;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                await loadChats();
            } else {
                currentUser = null;
                authModal.classList.add('active');
                messageInput.disabled = true;
                sendBtn.disabled = true;
            }
        });

        // Google Sign In
        googleBtn.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                showToast('Welcome!');
            } catch (error) {
                showToast('Sign in failed', 'error');
            }
        });

        // Email Auth
        emailAuthBtn.addEventListener('click', async () => {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        showToast('Account created!');
                    } catch (err) {
                        showToast('Failed to create account', 'error');
                    }
                } else {
                    showToast('Sign in failed', 'error');
                }
            }
        });

        // Get Local Response
        function getLocalResponse(msg) {
            const lower = msg.toLowerCase();
            
            for (const [key, data] of Object.entries(KNOWLEDGE_BASE)) {
                for (const pattern of data.patterns) {
                    if (lower.includes(pattern)) {
                        if (Array.isArray(data.responses)) {
                            return data.responses[Math.floor(Math.random() * data.responses.length)];
                        }
                        return data.response;
                    }
                }
            }
            return null;
        }

        // Send Message
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentUser) return;

            const now = Date.now();
            if (now - lastRequestTime < 1000) {
                showToast('Please wait a moment...', 'warning');
                return;
            }
            lastRequestTime = now;

            welcomeScreen.style.display = 'none';
            addMessage(text, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Add to conversation history with proper context
            conversationHistory.push({ role: 'user', content: text });

            // Check local knowledge
            const localResp = getLocalResponse(text);
            if (localResp) {
                setTimeout(() => {
                    addMessage(localResp, 'assistant', true);
                    conversationHistory.push({ role: 'assistant', content: localResp });
                    saveMessage(text, 'user');
                    saveMessage(localResp, 'assistant');
                }, 300);
                return;
            }

            const typingId = showTyping();

            try {
                // Prepare messages with system prompt and conversation history
                const messages = [
                    {
                        role: 'system',
                        content: 'You are Darpan, an intelligent AI assistant created by the Ajiva Talks team. You specialize in deep, thoughtful conversations about philosophy, literature, art, and culture. Be eloquent, insightful, and engaging. Keep responses concise but meaningful.'
                    },
                    ...conversationHistory.slice(-10) // Keep last 10 messages for context
                ];

                const response = await fetch(SARVAM_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-subscription-key': SARVAM_API_KEY
                    },
                    body: JSON.stringify({
                        model: 'sarvam-2b',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 1000,
                        top_p: 0.9
                    })
                });

                removeTyping(typingId);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: errorData
                    });
                    
                    let fallbackResponse = "I apologize, but I'm having trouble connecting right now. Let me share a thoughtful perspective on your question...";
                    
                    if (response.status === 401 || response.status === 403) {
                        fallbackResponse = "I'm experiencing authentication issues. However, I can still discuss " + text.substring(0, 50) + "... What specific aspect would you like to explore?";
                    } else if (response.status === 429) {
                        fallbackResponse = "I need a moment to gather my thoughts. Your question about " + text.substring(0, 50) + " is intriguing. Could you elaborate a bit more?";
                    }
                    
                    addMessage(fallbackResponse, 'assistant', true);
                    conversationHistory.push({ role: 'assistant', content: fallbackResponse });
                    await saveMessage(text, 'user');
                    await saveMessage(fallbackResponse, 'assistant');
                    return;
                }

                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
                    throw new Error("Invalid response format");
                }
                
                let aiText = data.choices[0].message.content.trim();

                // Brand consistency
                aiText = aiText
                    .replace(/Sarvam\s*AI/gi, 'Darpan')
                    .replace(/I am Sarvam/gi, 'I am Darpan')
                    .replace(/created by Sarvam/gi, 'created by Ajiva Talks')
                    .replace(/developed by Sarvam/gi, 'developed by Ajiva Talks')
                    .replace(/Sarvam/gi, 'Darpan');

                addMessage(aiText, 'assistant', true);
                conversationHistory.push({ role: 'assistant', content: aiText });
                
                await saveMessage(text, 'user');
                await saveMessage(aiText, 'assistant');

            } catch (error) {
                removeTyping(typingId);
                console.error('Send message error:', error);
                
                // Remove the user message from history if API call failed
                if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'user') {
                    conversationHistory.pop();
                }
                
                const fallbackMsg = "I appreciate your question. While I'm having technical difficulties, I'd love to engage with your thoughts. Could you share more about what interests you in this topic?";
                addMessage(fallbackMsg, 'assistant', true);
                conversationHistory.push({ role: 'assistant', content: fallbackMsg });
            }
        }

        // Parse Markdown
        function parseMarkdown(text) {
            text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            text = text.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__([^_]+)__/g, '<strong>$1</strong>');
            text = text.replace(/\*([^\*]+)\*/g, '<em>$1</em>');
            text = text.replace(/_([^_]+)_/g, '<em>$1</em>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        // Add Message
        function addMessage(text, role, animate = false) {
            const messageId = 'msg-' + Date.now() + '-' + Math.random();
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.dataset.messageId = messageId;
            div.dataset.originalText = text;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            if (role === 'assistant') {
                avatar.innerHTML = '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 500 500\'%3E%3Crect fill=\'%23f5f5dc\' width=\'500\' height=\'500\'/%3E%3Ctext x=\'250\' y=\'320\' font-family=\'Arial, sans-serif\' font-size=\'120\' font-weight=\'500\' text-anchor=\'middle\' fill=\'%23000\'%3Edarpan%3C/text%3E%3C/svg%3E" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">';
            } else {
                avatar.textContent = 'üë§';
            }
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            const editInput = document.createElement('textarea');
            editInput.className = 'message-edit-input';
            editInput.value = text;
            
            const editActions = document.createElement('div');
            editActions.className = 'message-edit-actions';
            
            const saveEditBtn = document.createElement('button');
            saveEditBtn.className = 'action-btn primary';
            saveEditBtn.textContent = 'Save';
            saveEditBtn.onclick = () => saveEdit(messageId);
            
            const cancelEditBtn = document.createElement('button');
            cancelEditBtn.className = 'action-btn';
            cancelEditBtn.textContent = 'Cancel';
            cancelEditBtn.onclick = () => cancelEdit(messageId);
            
            editActions.appendChild(saveEditBtn);
            editActions.appendChild(cancelEditBtn);
            
            if (animate && role === 'assistant') {
                let i = 0;
                const interval = setInterval(() => {
                    const currentText = text.substring(0, i + 1);
                    messageText.innerHTML = parseMarkdown(currentText);
                    i++;
                    scrollToBottom();
                    if (i >= text.length) {
                        clearInterval(interval);
                        addActions(content, text, messageId, role);
                    }
                }, 15);
            } else {
                messageText.innerHTML = parseMarkdown(text);
                if (role === 'assistant') addActions(content, text, messageId, role);
                else addUserActions(content, text, messageId);
            }
            
            content.appendChild(messageText);
            content.appendChild(editInput);
            content.appendChild(editActions);
            div.appendChild(avatar);
            div.appendChild(content);
            messagesContainer.appendChild(div);
            
            messageElements.set(messageId, { div, messageText, editInput, editActions });
            
            scrollToBottom();
        }

        // Add Actions for Assistant Messages
        function addActions(parent, text, messageId, role) {
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            
            const copy = document.createElement('button');
            copy.className = 'action-btn';
            copy.textContent = 'üìã Copy';
            copy.onclick = () => copyText(text);
            
            const quote = document.createElement('button');
            quote.className = 'action-btn';
            quote.textContent = 'üì∏ Create Quote';
            quote.onclick = () => generateQuote(text);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-btn danger';
            deleteBtn.textContent = 'üóëÔ∏è Delete';
            deleteBtn.onclick = () => deleteMessage(messageId);
            
            actions.appendChild(copy);
            actions.appendChild(quote);
            actions.appendChild(deleteBtn);
            parent.appendChild(actions);
        }

        // Add Actions for User Messages
        function addUserActions(parent, text, messageId) {
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            
            const edit = document.createElement('button');
            edit.className = 'action-btn';
            edit.textContent = '‚úèÔ∏è Edit';
            edit.onclick = () => startEdit(messageId);
            
            const copy = document.createElement('button');
            copy.className = 'action-btn';
            copy.textContent = 'üìã Copy';
            copy.onclick = () => copyText(text);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-btn danger';
            deleteBtn.textContent = 'üóëÔ∏è Delete';
            deleteBtn.onclick = () => deleteMessage(messageId);
            
            actions.appendChild(edit);
            actions.appendChild(copy);
            actions.appendChild(deleteBtn);
            parent.appendChild(actions);
        }

        // Copy Text
        function copyText(text) {
            // Remove HTML tags for clean copy
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = parseMarkdown(text);
            const cleanText = tempDiv.textContent || tempDiv.innerText;
            
            navigator.clipboard.writeText(cleanText).then(() => {
                showToast('Copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        // Start Edit
        function startEdit(messageId) {
            const elements = messageElements.get(messageId);
            if (!elements) return;
            
            elements.messageText.classList.add('editing');
            elements.editInput.classList.add('active');
            elements.editActions.classList.add('active');
            elements.editInput.focus();
        }

        // Cancel Edit
        function cancelEdit(messageId) {
            const elements = messageElements.get(messageId);
            if (!elements) return;
            
            const div = elements.div;
            const originalText = div.dataset.originalText;
            
            elements.messageText.classList.remove('editing');
            elements.editInput.classList.remove('active');
            elements.editActions.classList.remove('active');
            elements.editInput.value = originalText;
        }

        // Save Edit
        async function saveEdit(messageId) {
            const elements = messageElements.get(messageId);
            if (!elements) return;
            
            const div = elements.div;
            const newText = elements.editInput.value.trim();
            
            if (!newText) {
                showToast('Message cannot be empty', 'error');
                return;
            }
            
            div.dataset.originalText = newText;
            elements.messageText.innerHTML = parseMarkdown(newText);
            elements.messageText.classList.remove('editing');
            elements.editInput.classList.remove('active');
            elements.editActions.classList.remove('active');
            
            // Update conversation history
            const messageIndex = Array.from(messagesContainer.children)
                .filter(child => child.classList.contains('message'))
                .indexOf(div);
            
            if (messageIndex >= 0 && messageIndex < conversationHistory.length) {
                conversationHistory[messageIndex].content = newText;
            }
            
            showToast('Message updated');
        }

        // Delete Message
        async function deleteMessage(messageId) {
            if (!confirm('Delete this message?')) return;
            
            const elements = messageElements.get(messageId);
            if (!elements) return;
            
            const div = elements.div;
            const messageIndex = Array.from(messagesContainer.children)
                .filter(child => child.classList.contains('message'))
                .indexOf(div);
            
            // Remove from DOM
            div.remove();
            messageElements.delete(messageId);
            
            // Remove from conversation history
            if (messageIndex >= 0 && messageIndex < conversationHistory.length) {
                conversationHistory.splice(messageIndex, 1);
            }
            
            showToast('Message deleted');
        }

        // Generate Quote
        function generateQuote(text) {
            const ctx = quoteCanvas.getContext('2d');
            const width = 1080;
            const height = 1920;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Gradient background
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#0f0f1e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // Add subtle pattern
            ctx.fillStyle = 'rgba(255, 255, 255, 0.02)';
            for (let i = 0; i < 50; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * width, Math.random() * height, Math.random() * 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Quote text
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 56px Inter, sans-serif';
            ctx.textAlign = 'center';
            
            // Word wrap
            const maxWidth = width - 200;
            const words = text.split(' ');
            let lines = [];
            let currentLine = '';
            
            words.forEach(word => {
                const testLine = currentLine + word + ' ';
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && currentLine !== '') {
                    lines.push(currentLine);
                    currentLine = word + ' ';
                } else {
                    currentLine = testLine;
                }
            });
            lines.push(currentLine);
            
            // Draw text
            const lineHeight = 80;
            const startY = (height - (lines.length * lineHeight)) / 2;
            lines.forEach((line, i) => {
                ctx.fillText(line, width / 2, startY + (i * lineHeight));
            });
            
            // Darpan watermark
            ctx.font = '32px Instrument Serif, serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.fillText('‚Äî Darpan', width / 2, height - 200);
            
            ctx.font = '24px Inter, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.fillText('by Ajiva Talks', width / 2, height - 150);
            
            quoteModal.classList.add('active');
        }

        // Download Quote
        downloadQuoteBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'darpan-quote-' + Date.now() + '.png';
            link.href = quoteCanvas.toDataURL();
            link.click();
            showToast('Quote downloaded!');
        });

        // Close Quote Modal
        closeQuoteBtn.addEventListener('click', () => {
            quoteModal.classList.remove('active');
        });

        // Close quote modal on outside click
        quoteModal.addEventListener('click', (e) => {
            if (e.target === quoteModal) {
                quoteModal.classList.remove('active');
            }
        });

        // Typing Indicator
        function showTyping() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message assistant';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 500 500\'%3E%3Crect fill=\'%23f5f5dc\' width=\'500\' height=\'500\'/%3E%3Ctext x=\'250\' y=\'320\' font-family=\'Arial, sans-serif\' font-size=\'120\' font-weight=\'500\' text-anchor=\'middle\' fill=\'%23000\'%3Edarpan%3C/text%3E%3C/svg%3E" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">';
            
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            
            div.appendChild(avatar);
            div.appendChild(indicator);
            messagesContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // Scroll
        function scrollToBottom() {
            messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
        }

        // Save Message
        async function saveMessage(text, role) {
            if (!currentUser) return;
            
            try {
                if (!currentChatId) {
                    currentChatId = db.collection('chats').doc().id;
                    const title = text.substring(0, 50) + (text.length > 50 ? '...' : '');
                    
                    await db.collection('chats').doc(currentChatId).set({
                        userId: currentUser.uid,
                        title: title,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    loadChats().catch(err => console.error('Load chats after create:', err));
                }
                
                await db.collection('chats').doc(currentChatId).collection('messages').add({
                    text: text,
                    role: role,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection('chats').doc(currentChatId).update({
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error('Save message error:', error);
            }
        }

        // Load Chats
        async function loadChats() {
            if (!currentUser) {
                chatList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">Sign in to see your chats</div>';
                return;
            }
            
            try {
                let snapshot;
                try {
                    snapshot = await db.collection('chats')
                        .where('userId', '==', currentUser.uid)
                        .orderBy('updatedAt', 'desc')
                        .limit(50)
                        .get();
                } catch (orderError) {
                    snapshot = await db.collection('chats')
                        .where('userId', '==', currentUser.uid)
                        .limit(50)
                        .get();
                }
                
                chatList.innerHTML = '';
                
                if (snapshot.empty) {
                    chatList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">No previous chats</div>';
                    return;
                }
                
                const chats = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    chats.push({ id: doc.id, ...data });
                });
                
                chats.sort((a, b) => {
                    if (!a.updatedAt || !b.updatedAt) return 0;
                    return b.updatedAt.toMillis() - a.updatedAt.toMillis();
                });
                
                chats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    if (chat.id === currentChatId) item.classList.add('active');
                    
                    const title = document.createElement('span');
                    title.textContent = chat.title || 'New Chat';
                    title.style.flex = '1';
                    title.style.overflow = 'hidden';
                    title.style.textOverflow = 'ellipsis';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'chat-item-delete';
                    deleteBtn.textContent = 'üóëÔ∏è';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteChat(chat.id);
                    };
                    
                    item.appendChild(title);
                    item.appendChild(deleteBtn);
                    item.onclick = () => loadChat(chat.id);
                    chatList.appendChild(item);
                });
                
            } catch (error) {
                console.error('Load chats error:', error);
                chatList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">Unable to load chats</div>';
            }
        }

        // Delete Chat
        async function deleteChat(chatId) {
            if (!confirm('Delete this entire conversation?')) return;
            
            try {
                // Delete all messages in the chat
                const messagesSnapshot = await db.collection('chats').doc(chatId).collection('messages').get();
                const batch = db.batch();
                messagesSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Delete the chat document
                await db.collection('chats').doc(chatId).delete();
                
                // If this was the current chat, clear it
                if (chatId === currentChatId) {
                    currentChatId = null;
                    conversationHistory = [];
                    messagesContainer.innerHTML = '';
                    welcomeScreen.style.display = 'flex';
                }
                
                await loadChats();
                showToast('Chat deleted');
            } catch (error) {
                console.error('Delete chat error:', error);
                showToast('Failed to delete chat', 'error');
            }
        }

        // Load Chat
        async function loadChat(chatId) {
            currentChatId = chatId;
            messagesContainer.innerHTML = '';
            welcomeScreen.style.display = 'none';
            conversationHistory = [];
            messageElements.clear();
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-messages';
            loadingDiv.style.cssText = 'text-align: center; padding: 2rem; color: var(--text-secondary);';
            loadingDiv.textContent = 'Loading messages...';
            messagesContainer.appendChild(loadingDiv);
            
            try {
                let snapshot;
                try {
                    snapshot = await db.collection('chats').doc(chatId).collection('messages')
                        .orderBy('timestamp', 'asc')
                        .get();
                } catch (orderError) {
                    snapshot = await db.collection('chats').doc(chatId).collection('messages')
                        .get();
                }
                
                const loading = document.getElementById('loading-messages');
                if (loading) loading.remove();
                
                if (snapshot.empty) {
                    welcomeScreen.style.display = 'flex';
                    return;
                }
                
                const messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    messages.push(data);
                });
                
                messages.sort((a, b) => {
                    if (!a.timestamp || !b.timestamp) return 0;
                    return a.timestamp.toMillis() - b.timestamp.toMillis();
                });
                
                messages.forEach(data => {
                    addMessage(data.text, data.role);
                    conversationHistory.push({ role: data.role, content: data.text });
                });
                
                scrollToBottom();
                await loadChats();
                
            } catch (error) {
                console.error('Load chat error:', error);
                const loading = document.getElementById('loading-messages');
                if (loading) loading.remove();
                showToast('Failed to load chat', 'error');
                welcomeScreen.style.display = 'flex';
            }
        }

        // New Chat
        newChatBtn.addEventListener('click', () => {
            currentChatId = null;
            conversationHistory = [];
            messageElements.clear();
            messagesContainer.innerHTML = '';
            welcomeScreen.style.display = 'flex';
            loadChats();
            sidebar.classList.add('hidden');
        });

        // Toast
        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            if (type === 'error') toast.style.borderColor = 'var(--error)';
            if (type === 'warning') toast.style.borderColor = 'var(--warning)';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Use Prompt
        function usePrompt(text) {
            messageInput.value = text;
            messageInput.focus();
        }

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                newChatBtn.click();
            }
        });
    </script>
</body>
</html>
