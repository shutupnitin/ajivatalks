<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Darpan - Intelligent Conversations | Ajiva Talks</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Darpan by Ajiva Talks - Your intelligent companion for deep conversations about philosophy, culture, and ideas.">
    <meta name="keywords" content="AI chat, Darpan, Ajiva Talks, intelligent assistant, conversations">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Darpan - Intelligent Conversations">
    <meta property="og:description" content="Experience thoughtful AI conversations with Darpan by Ajiva Talks">
    <meta property="og:type" content="website">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #0f0f0f;
            --bg-tertiary: #141414;
            --text-primary: #e8e8e8;
            --text-secondary: #999999;
            --border-primary: #1f1f1f;
            --border-secondary: #2a2a2a;
            --accent: #ffffff;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --blue: #3b82f6;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header */
        .header {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-primary);
            padding: 0.875rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            height: 60px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-toggle {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-primary);
            font-size: 1.2rem;
        }

        .menu-toggle:hover {
            background: var(--bg-secondary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .logo-img {
            height: 24px;
            width: auto;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .quota-badge {
            padding: 0.5rem 0.875rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--success);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 1.5px solid var(--border-secondary);
            transition: all 0.2s;
            object-fit: cover;
        }

        .user-avatar:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .auth-btn {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .auth-btn:hover {
            opacity: 0.9;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            height: calc(100dvh - 60px);
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }

        .new-chat-btn {
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .new-chat-btn:hover {
            background: var(--bg-secondary);
        }

        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .chat-item {
            padding: 0.625rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .chat-item:hover .chat-delete {
            opacity: 1;
        }

        .chat-item.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .chat-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-delete {
            opacity: 0;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-delete:hover {
            background: var(--bg-tertiary);
            color: var(--error);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .messages-container {
            max-width: 48rem;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 200px);
            text-align: center;
            padding: 2rem 1rem;
        }

        .welcome-icon {
            width: 100px;
            height: 100px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .welcome-title {
            font-family: 'Instrument Serif', serif;
            font-size: 2rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .welcome-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            max-width: 500px;
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.75rem;
            max-width: 800px;
            width: 100%;
        }

        .prompt-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .prompt-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-secondary);
        }

        .prompt-card-title {
            font-weight: 600;
            margin-bottom: 0.375rem;
            font-size: 0.875rem;
        }

        .prompt-card-text {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.875rem;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-text {
            line-height: 1.6;
            color: var(--text-primary);
            font-size: 0.9375rem;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-text strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-text em {
            font-style: italic;
        }

        .message-text code {
            background: var(--bg-tertiary);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .message-text pre {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5rem 0;
            border: 1px solid var(--border-primary);
        }

        .message-text pre code {
            background: transparent;
            padding: 0;
            border: none;
            font-size: 0.875rem;
            display: block;
            white-space: pre;
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.625rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            padding: 0.375rem 0.625rem;
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 0;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-6px); }
        }

        /* Input Area */
        .input-area {
            border-top: 1px solid var(--border-primary);
            padding: 1rem;
            background: var(--bg-primary);
        }

        .input-wrapper {
            max-width: 48rem;
            margin: 0 auto;
            position: relative;
        }

        .input-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            transition: all 0.2s;
        }

        .input-container:focus-within {
            border-color: var(--border-secondary);
            background: var(--bg-tertiary);
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            resize: none;
            max-height: 200px;
            line-height: 1.5;
        }

        .message-input::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            width: 32px;
            height: 32px;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            font-size: 1.2rem;
        }

        .send-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Auth Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-family: 'Instrument Serif', serif;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-input {
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--border-secondary);
        }

        .google-btn {
            padding: 0.75rem;
            background: white;
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .google-btn:hover {
            opacity: 0.9;
        }

        .divider {
            text-align: center;
            position: relative;
            margin: 0.5rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 43%;
            height: 1px;
            background: var(--border-primary);
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        /* Confirm Dialog */
        .confirm-dialog {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 1rem;
        }

        .confirm-dialog.active {
            display: flex;
        }

        .confirm-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            animation: modalSlide 0.2s ease-out;
        }

        .confirm-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .confirm-message {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            margin-bottom: 1.5rem;
        }

        .confirm-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .confirm-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .confirm-btn.cancel {
            background: transparent;
            color: var(--text-primary);
        }

        .confirm-btn.cancel:hover {
            background: var(--bg-tertiary);
        }

        .confirm-btn.delete {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        .confirm-btn.delete:hover {
            opacity: 0.9;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 0.875rem 1.25rem;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
            font-size: 0.875rem;
        }

        .toast.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .toast.success {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3a3a3a;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 60px;
                height: calc(100vh - 60px);
                z-index: 90;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
            }

            .example-prompts {
                grid-template-columns: 1fr;
            }

            .welcome-title {
                font-size: 1.5rem;
            }

            .messages-container {
                padding: 1rem 0.75rem;
            }

            .message {
                gap: 0.75rem;
            }
        }

        @media (max-width: 640px) {
            .header {
                padding: 0.75rem 1rem;
            }

            .input-area {
                padding: 0.75rem;
            }

            .quota-badge span:first-child {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle">☰</button>
            <div class="logo">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 500 500'%3E%3Crect fill='%23f5f5dc' width='500' height='500'/%3E%3Ctext x='250' y='320' font-family='Arial, sans-serif' font-size='120' font-weight='500' text-anchor='middle' fill='%23000'%3Edarpan%3C/text%3E%3C/svg%3E" alt="Darpan" class="logo-img">
            </div>
        </div>
        <div class="header-right">
            <div class="quota-badge">
                <span>∞</span>
                <span>Unlimited</span>
            </div>
            <div id="userSection">
                <button class="auth-btn" id="authBtn">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar hidden" id="sidebar">
            <div class="sidebar-content">
                <button class="new-chat-btn" id="newChatBtn">
                    <span>+</span>
                    <span>New chat</span>
                </button>
                <div class="chat-list" id="chatList">
                    <!-- Chats will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-container">
            <div class="messages-wrapper" id="messagesWrapper">
                <div class="messages-container" id="messagesContainer">
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 500 500'%3E%3Crect fill='%23f5f5dc' width='500' height='500'/%3E%3Ctext x='250' y='320' font-family='Arial, sans-serif' font-size='120' font-weight='500' text-anchor='middle' fill='%23000'%3Edarpan%3C/text%3E%3C/svg%3E" alt="Darpan" style="width: 100px; height: auto; border-radius: 12px;">
                        </div>
                        <h1 class="welcome-title">Welcome to Darpan</h1>
                        <p class="welcome-subtitle">Your intelligent companion for deep conversations about philosophy, culture, and the human experience. Created by Ajiva Talks.</p>
                        <div class="example-prompts">
                            <div class="prompt-card" onclick="usePrompt('Tell me about the philosophy of consciousness')">
                                <div class="prompt-card-title">Philosophy</div>
                                <div class="prompt-card-text">Explore consciousness and existence</div>
                            </div>
                            <div class="prompt-card" onclick="usePrompt('What makes literature timeless?')">
                                <div class="prompt-card-title">Literature</div>
                                <div class="prompt-card-text">Discuss great narratives</div>
                            </div>
                            <div class="prompt-card" onclick="usePrompt('Explain the role of art in society')">
                                <div class="prompt-card-title">Culture</div>
                                <div class="prompt-card-text">Understand cultural impact</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input -->
            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-container">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="Message Darpan..." 
                            rows="1"
                            disabled
                        ></textarea>
                        <button class="send-btn" id="sendBtn" disabled>→</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <h2 class="modal-title">Sign in to Darpan</h2>
            <div class="auth-form">
                <button class="google-btn" id="googleBtn">
                    <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.48c.45-1.45 1.6-2.48 3.48-3.3z"/></svg>
                    <span>Continue with Google</span>
                </button>
                <div class="divider">or</div>
                <input type="email" class="form-input" id="emailInput" placeholder="Email">
                <input type="password" class="form-input" id="passwordInput" placeholder="Password">
                <button class="auth-btn" id="emailAuthBtn" style="width: 100%">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-title">Delete Chat?</div>
            <div class="confirm-message">This will permanently delete this conversation. This action cannot be undone.</div>
            <div class="confirm-actions">
                <button class="confirm-btn cancel" id="confirmCancel">Cancel</button>
                <button class="confirm-btn delete" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAGYl3DZDq7S714sveY4yq2s_O5JaFSuf4",
            authDomain: "ajiva-talks.firebaseapp.com",
            projectId: "ajiva-talks",
            storageBucket: "ajiva-talks.firebasestorage.app",
            messagingSenderId: "627601368262",
            appId: "1:627601368262:web:8512d155109d1bab5ca3c7"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // API Config
        const SARVAM_API_KEY = 'sk_2sx31xrp_tSHiL5KpvaS52RHOakucpC1D';
        const SARVAM_URL = 'https://api.sarvam.ai/v1/chat/completions';

        // Knowledge Base
        const KNOWLEDGE_BASE = {
            greetings: {
                patterns: ['hello', 'hi', 'hey', 'namaste', 'good morning', 'good evening', 'good afternoon'],
                responses: [
                    "Hello! I'm Darpan, your companion for meaningful conversations. How may I assist you today?",
                    "Greetings! I'm here to explore ideas and engage in thoughtful dialogue with you.",
                    "Hello! Welcome to Darpan. What would you like to discuss?"
                ]
            },
            identity: {
                patterns: ['who are you', 'what are you', 'who made you', 'who created you', 'your creator', 'your origin', 'built you', 'developed you'],
                response: "I'm Darpan, an intelligent AI assistant created by the Ajiva Talks team. My purpose is to facilitate deep, meaningful conversations about philosophy, culture, literature, and the human experience. I'm here to help you explore complex ideas through thoughtful dialogue."
            },
            capabilities: {
                patterns: ['what can you do', 'your capabilities', 'how can you help', 'what do you know'],
                response: "I specialize in engaging conversations about philosophy, literature, art, culture, and complex ideas. I can help you explore concepts, analyze perspectives, discuss creative works, and dive deep into meaningful topics. What interests you?"
            },
            thanks: {
                patterns: ['thank you', 'thanks', 'appreciate'],
                responses: ["You're welcome! Happy to help.", "My pleasure! Let me know if you need anything else.", "Glad I could assist!"]
            }
        };

        // State
        let currentUser = null;
        let currentChatId = null;
        let conversationHistory = [];
        let lastRequestTime = 0;
        let chatToDelete = null;

        // DOM
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const authModal = document.getElementById('authModal');
        const authBtn = document.getElementById('authBtn');
        const googleBtn = document.getElementById('googleBtn');
        const emailAuthBtn = document.getElementById('emailAuthBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesContainer = document.getElementById('messagesContainer');
        const messagesWrapper = document.getElementById('messagesWrapper');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const newChatBtn = document.getElementById('newChatBtn');
        const chatList = document.getElementById('chatList');
        const confirmDialog = document.getElementById('confirmDialog');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmDelete = document.getElementById('confirmDelete');

        // Toggle Sidebar
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
        });

        // Auth State
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                authModal.classList.remove('active');
                
                const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=random`;
                
                document.getElementById('userSection').innerHTML = `
                    <img src="${photoURL}" 
                         class="user-avatar" 
                         alt="User"
                         onerror="this.src='https://ui-avatars.com/api/?name=User&background=random'">
                `;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                await loadChats();
            } else {
                currentUser = null;
                authModal.classList.add('active');
                messageInput.disabled = true;
                sendBtn.disabled = true;
                document.getElementById('userSection').innerHTML = `
                    <button class="auth-btn" id="authBtn">Sign In</button>
                `;
            }
        });

        // Google Sign In
        googleBtn.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                showToast('Welcome!', 'success');
            } catch (error) {
                console.error('Google sign in error:', error);
                showToast('Sign in failed', 'error');
            }
        });

        // Email Auth
        emailAuthBtn.addEventListener('click', async () => {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showToast('Welcome back!', 'success');
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        showToast('Account created!', 'success');
                    } catch (err) {
                        console.error('Create account error:', err);
                        showToast('Failed to create account', 'error');
                    }
                } else {
                    console.error('Sign in error:', error);
                    showToast('Sign in failed', 'error');
                }
            }
        });

        // Get Local Response
        function getLocalResponse(msg) {
            const lower = msg.toLowerCase();
            
            for (const [key, data] of Object.entries(KNOWLEDGE_BASE)) {
                for (const pattern of data.patterns) {
                    if (lower.includes(pattern)) {
                        if (Array.isArray(data.responses)) {
                            return data.responses[Math.floor(Math.random() * data.responses.length)];
                        }
                        return data.response;
                    }
                }
            }
            return null;
        }

        // Send Message
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentUser) return;

            const now = Date.now();
            if (now - lastRequestTime < 1000) {
                showToast('Please wait a moment...', 'error');
                return;
            }
            lastRequestTime = now;

            welcomeScreen.style.display = 'none';
            addMessage(text, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            conversationHistory.push({ role: 'user', content: text });

            // Check local knowledge first
            const localResp = getLocalResponse(text);
            if (localResp) {
                setTimeout(() => {
                    addMessage(localResp, 'assistant', true);
                    conversationHistory.push({ role: 'assistant', content: localResp });
                    saveMessage(text, 'user');
                    saveMessage(localResp, 'assistant');
                }, 300);
                return;
            }

            const typingId = showTyping();

            try {
                // Build messages array with system prompt and conversation history
                const messages = [
                    {
                        role: 'system',
                        content: 'You are Darpan, an intelligent AI assistant created by the Ajiva Talks team. You specialize in deep, thoughtful conversations about philosophy, literature, art, and culture. Be eloquent, insightful, and engaging. Keep responses clear and well-structured.'
                    },
                    ...conversationHistory.slice(-6) // Last 6 messages for context
                ];

                console.log('Sending request to Sarvam API...');
                console.log('Messages:', messages);

                const response = await fetch(SARVAM_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'API-Subscription-Key': SARVAM_API_KEY
                    },
                    body: JSON.stringify({
                        model: 'sarvam-m',
                        messages: messages,
                        temperature: 0.7,
                        top_p: 1
                    })
                });

                console.log('Response status:', response.status);

                removeTyping(typingId);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { message: errorText };
                    }
                    
                    console.error('API Error:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: errorData
                    });
                    
                    // Provide intelligent fallback
                    const fallbackResponse = generateFallbackResponse(text);
                    addMessage(fallbackResponse, 'assistant', true);
                    conversationHistory.push({ role: 'assistant', content: fallbackResponse });
                    await saveMessage(text, 'user');
                    await saveMessage(fallbackResponse, 'assistant');
                    
                    // Show specific error message
                    if (response.status === 403) {
                        showToast('API key issue - using fallback', 'error');
                    } else if (response.status === 429) {
                        showToast('Rate limit reached - using fallback', 'error');
                    } else {
                        showToast('API temporarily unavailable - using fallback', 'error');
                    }
                    return;
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
                    console.error('Invalid response structure:', data);
                    
                    // Fallback response
                    const fallbackResponse = generateFallbackResponse(text);
                    addMessage(fallbackResponse, 'assistant', true);
                    conversationHistory.push({ role: 'assistant', content: fallbackResponse });
                    await saveMessage(text, 'user');
                    await saveMessage(fallbackResponse, 'assistant');
                    return;
                }
                
                let aiText = data.choices[0].message.content.trim();

                if (!aiText || aiText.length < 3) {
                    console.error('Empty response:', aiText);
                    
                    // Fallback response
                    const fallbackResponse = generateFallbackResponse(text);
                    addMessage(fallbackResponse, 'assistant', true);
                    conversationHistory.push({ role: 'assistant', content: fallbackResponse });
                    await saveMessage(text, 'user');
                    await saveMessage(fallbackResponse, 'assistant');
                    return;
                }

                // Ensure brand consistency
                aiText = aiText
                    .replace(/Sarvam\s*AI/gi, 'Darpan')
                    .replace(/I am Sarvam/gi, 'I am Darpan')
                    .replace(/created by Sarvam/gi, 'created by Ajiva Talks')
                    .replace(/developed by Sarvam/gi, 'developed by Ajiva Talks');

                console.log('Displaying response:', aiText.substring(0, 100) + '...');

                addMessage(aiText, 'assistant', true);
                conversationHistory.push({ role: 'assistant', content: aiText });
                
                await saveMessage(text, 'user');
                await saveMessage(aiText, 'assistant');

            } catch (error) {
                removeTyping(typingId);
                console.error('Send message error:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                // Provide intelligent fallback
                const fallbackResponse = generateFallbackResponse(text);
                addMessage(fallbackResponse, 'assistant', true);
                conversationHistory.push({ role: 'assistant', content: fallbackResponse });
                
                await saveMessage(text, 'user');
                await saveMessage(fallbackResponse, 'assistant');
                
                showToast('Connection error - using fallback mode', 'error');
            }
        }

        // Generate Fallback Response
        function generateFallbackResponse(userMessage) {
            const msg = userMessage.toLowerCase();
            
            // Philosophy-related
            if (msg.includes('philosophy') || msg.includes('consciousness') || msg.includes('existence') || msg.includes('reality')) {
                return "That's a profound philosophical question. The nature of consciousness and existence has fascinated thinkers for millennia. From Descartes' 'I think, therefore I am' to modern neuroscience, we continue to explore the fundamental nature of being and awareness. What aspect of this topic intrigues you most?";
            }
            
            // Literature-related
            if (msg.includes('literature') || msg.includes('book') || msg.includes('story') || msg.includes('novel') || msg.includes('poem') || msg.includes('author')) {
                return "Literature offers us windows into diverse human experiences and perspectives. Great works endure because they touch on universal themes while capturing the unique contexts of their time. What draws you to this particular aspect of literature?";
            }
            
            // Art and culture
            if (msg.includes('art') || msg.includes('culture') || msg.includes('society') || msg.includes('music') || msg.includes('painting')) {
                return "Art and culture reflect and shape our collective consciousness. They serve as both mirrors and windows—showing us who we are while opening perspectives on different ways of being. Each cultural expression carries layers of meaning and historical context. What specific aspect would you like to explore?";
            }
            
            // India-related
            if (msg.includes('india') || msg.includes('indian') || msg.includes('hindi') || msg.includes('sanskrit')) {
                return "India has a rich cultural and intellectual heritage spanning thousands of years. From ancient philosophical traditions like Vedanta and Buddhism to classical arts, literature, and music, Indian civilization has made profound contributions to human thought and creativity. What particular aspect of Indian culture interests you?";
            }
            
            // Science and knowledge
            if (msg.includes('science') || msg.includes('technology') || msg.includes('knowledge') || msg.includes('learn')) {
                return "The pursuit of knowledge is one of humanity's noblest endeavors. Whether through scientific inquiry, philosophical reflection, or artistic expression, we seek to understand our world and our place in it. I'm currently in fallback mode, but I'm still here to engage with your questions. What would you like to explore?";
            }
            
            // General thoughtful response
            return "That's an interesting question that deserves thoughtful consideration. I'm currently experiencing some technical connectivity issues, but I'm still here to engage with your ideas. Could you share more about what specifically interests you? I'll do my best to provide meaningful insights based on the context you provide.";
        }

        // Parse Markdown
        function parseMarkdown(text) {
            text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            text = text.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__([^_]+)__/g, '<strong>$1</strong>');
            text = text.replace(/\*([^\*]+)\*/g, '<em>$1</em>');
            text = text.replace(/_([^_]+)_/g, '<em>$1</em>');
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        // Add Message
        function addMessage(text, role, animate = false) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            if (role === 'assistant') {
                avatar.innerHTML = '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 500 500\'%3E%3Crect fill=\'%23f5f5dc\' width=\'500\' height=\'500\'/%3E%3Ctext x=\'250\' y=\'320\' font-family=\'Arial, sans-serif\' font-size=\'120\' font-weight=\'500\' text-anchor=\'middle\' fill=\'%23000\'%3Edarpan%3C/text%3E%3C/svg%3E" alt="Darpan">';
            } else {
                if (currentUser && currentUser.photoURL) {
                    avatar.innerHTML = `<img src="${currentUser.photoURL}" alt="User" onerror="this.parentElement.textContent='U'">`;
                } else {
                    avatar.textContent = 'U';
                }
            }
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            if (animate && role === 'assistant') {
                let i = 0;
                const interval = setInterval(() => {
                    const currentText = text.substring(0, i + 1);
                    messageText.innerHTML = parseMarkdown(currentText);
                    i++;
                    scrollToBottom();
                    if (i >= text.length) {
                        clearInterval(interval);
                        addActions(content, text);
                    }
                }, 15);
            } else {
                messageText.innerHTML = parseMarkdown(text);
                if (role === 'assistant') addActions(content, text);
            }
            
            content.appendChild(messageText);
            div.appendChild(avatar);
            div.appendChild(content);
            messagesContainer.appendChild(div);
            scrollToBottom();
        }

        // Add Actions
        function addActions(parent, text) {
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            
            const copy = document.createElement('button');
            copy.className = 'action-btn';
            copy.textContent = 'Copy';
            copy.onclick = () => {
                navigator.clipboard.writeText(text);
                showToast('Copied!', 'success');
            };
            
            actions.appendChild(copy);
            parent.appendChild(actions);
        }

        // Typing Indicator
        function showTyping() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message assistant';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 500 500\'%3E%3Crect fill=\'%23f5f5dc\' width=\'500\' height=\'500\'/%3E%3Ctext x=\'250\' y=\'320\' font-family=\'Arial, sans-serif\' font-size=\'120\' font-weight=\'500\' text-anchor=\'middle\' fill=\'%23000\'%3Edarpan%3C/text%3E%3C/svg%3E" alt="Darpan">';
            
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            
            div.appendChild(avatar);
            div.appendChild(indicator);
            messagesContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // Scroll
        function scrollToBottom() {
            messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
        }

        // Save Message
        async function saveMessage(text, role) {
            if (!currentUser) return;
            
            try {
                if (!currentChatId) {
                    currentChatId = db.collection('chats').doc().id;
                    const title = text.substring(0, 50) + (text.length > 50 ? '...' : '');
                    
                    await db.collection('chats').doc(currentChatId).set({
                        userId: currentUser.uid,
                        title: title,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    loadChats().catch(err => console.error('Load chats error:', err));
                }
                
                await db.collection('chats').doc(currentChatId).collection('messages').add({
                    text: text,
                    role: role,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection('chats').doc(currentChatId).update({
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error('Save message error:', error);
            }
        }

        // Load Chats
        async function loadChats() {
            if (!currentUser) {
                chatList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">Sign in to see your chats</div>';
                return;
            }
            
            try {
                const snapshot = await db.collection('chats')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('updatedAt', 'desc')
                    .limit(50)
                    .get();
                
                chatList.innerHTML = '';
                
                if (snapshot.empty) {
                    chatList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">No previous chats</div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    if (doc.id === currentChatId) item.classList.add('active');
                    
                    const title = document.createElement('div');
                    title.className = 'chat-title';
                    title.textContent = data.title || 'New Chat';
                    title.onclick = () => loadChat(doc.id);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'chat-delete';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        showDeleteConfirm(doc.id);
                    };
                    
                    item.appendChild(title);
                    item.appendChild(deleteBtn);
                    chatList.appendChild(item);
                });
                
            } catch (error) {
                console.error('Load chats error:', error);
                chatList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">Unable to load chats</div>';
            }
        }

        // Load Chat
        async function loadChat(chatId) {
            currentChatId = chatId;
            messagesContainer.innerHTML = '';
            welcomeScreen.style.display = 'none';
            conversationHistory = [];
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-messages';
            loadingDiv.style.cssText = 'text-align: center; padding: 2rem; color: var(--text-secondary);';
            loadingDiv.textContent = 'Loading messages...';
            messagesContainer.appendChild(loadingDiv);
            
            try {
                const snapshot = await db.collection('chats').doc(chatId).collection('messages')
                    .orderBy('timestamp', 'asc')
                    .get();
                
                const loading = document.getElementById('loading-messages');
                if (loading) loading.remove();
                
                if (snapshot.empty) {
                    welcomeScreen.style.display = 'flex';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    addMessage(data.text, data.role);
                    conversationHistory.push({ role: data.role, content: data.text });
                });
                
                scrollToBottom();
                await loadChats();
                sidebar.classList.add('hidden');
                
            } catch (error) {
                console.error('Load chat error:', error);
                const loading = document.getElementById('loading-messages');
                if (loading) loading.remove();
                showToast('Failed to load chat', 'error');
                welcomeScreen.style.display = 'flex';
            }
        }

        // Delete Chat Functions
        function showDeleteConfirm(chatId) {
            chatToDelete = chatId;
            confirmDialog.classList.add('active');
        }

        confirmCancel.addEventListener('click', () => {
            confirmDialog.classList.remove('active');
            chatToDelete = null;
        });

        confirmDelete.addEventListener('click', async () => {
            if (!chatToDelete) return;
            
            try {
                // Delete all messages in the chat
                const messagesSnapshot = await db.collection('chats').doc(chatToDelete).collection('messages').get();
                const batch = db.batch();
                messagesSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Delete the chat document
                await db.collection('chats').doc(chatToDelete).delete();
                
                // If deleted chat was current, start new chat
                if (chatToDelete === currentChatId) {
                    currentChatId = null;
                    conversationHistory = [];
                    messagesContainer.innerHTML = '';
                    welcomeScreen.style.display = 'flex';
                }
                
                confirmDialog.classList.remove('active');
                chatToDelete = null;
                
                showToast('Chat deleted', 'success');
                await loadChats();
                
            } catch (error) {
                console.error('Delete chat error:', error);
                showToast('Failed to delete chat', 'error');
            }
        });

        // Close dialog on outside click
        confirmDialog.addEventListener('click', (e) => {
            if (e.target === confirmDialog) {
                confirmDialog.classList.remove('active');
                chatToDelete = null;
            }
        });

        // New Chat
        newChatBtn.addEventListener('click', () => {
            currentChatId = null;
            conversationHistory = [];
            messagesContainer.innerHTML = '';
            welcomeScreen.style.display = 'flex';
            loadChats();
            sidebar.classList.add('hidden');
        });

        // Toast
        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Use Prompt
        function usePrompt(text) {
            messageInput.value = text;
            messageInput.focus();
        }

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Close modals on outside click
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) {
                // Don't allow closing auth modal if not signed in
                if (currentUser) {
                    authModal.classList.remove('active');
                }
            }
        });

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                newChatBtn.click();
            }
        });
    </script>
</body>
</html>
