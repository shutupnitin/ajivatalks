<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 
=============================================================================
PASTE THIS CODE IN THE <head> SECTION (AFTER THE OPENING <head> TAG)
=============================================================================
-->

<!-- Google Analytics 4 - Complete Tracking -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-C48YM39L27"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-C48YM39L27', {
    'send_page_view': true,
    'page_title': document.title,
    'page_location': window.location.href
  });

  // Track custom events
  window.trackEvent = function(eventName, eventParams) {
    gtag('event', eventName, eventParams);
  };
</script>

<!-- Enhanced SEO Meta Tags -->
<meta name="description" content="Darpan - Your AI companion for deep, meaningful conversations about philosophy, literature, art, and culture. Created by Ajiva Talks, powered by advanced AI technology for intelligent dialogue and exploration of complex ideas.">
<meta name="keywords" content="Darpan AI, Ajiva Talks, AI chat, intelligent conversations, philosophy discussions, literature analysis, cultural dialogue, AI assistant, deep conversations, Indian AI, Bangalore AI, artificial intelligence, chatbot, conversational AI">
<meta name="author" content="Ajiva Talks">
<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
<meta name="language" content="English">
<meta name="revisit-after" content="7 days">
<meta name="rating" content="general">
<meta name="distribution" content="global">
<meta name="theme-color" content="#0a0a0a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Darpan">
<meta name="application-name" content="Darpan">
<meta name="msapplication-TileColor" content="#0a0a0a">
<meta name="msapplication-config" content="/browserconfig.xml">

<!-- Canonical URL -->
<link rel="canonical" href="https://ajivatalks.in">

<!-- Open Graph Meta Tags (Facebook, LinkedIn) -->
<meta property="og:site_name" content="Darpan by Ajiva Talks">
<meta property="og:title" content="Darpan - Intelligent AI Conversations | Ajiva Talks">
<meta property="og:description" content="Experience thoughtful AI conversations with Darpan. Engage in deep discussions about philosophy, literature, culture, and ideas. Your intelligent companion for meaningful dialogue.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://ajivatalks.in">
<meta property="og:image" content="https://ajivatalks.in/og-image.jpeg">
<meta property="og:image:secure_url" content="https://ajivatalks.in/og-image.jpeg">
<meta property="og:image:type" content="image/png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="Darpan - AI Conversations by Ajiva Talks">
<meta property="og:locale" content="en_US">
<meta property="og:locale:alternate" content="hi_IN">

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@AjivaTalks">
<meta name="twitter:creator" content="@AjivaTalks">
<meta name="twitter:title" content="Darpan - Intelligent AI Conversations | Ajiva Talks">
<meta name="twitter:description" content="Experience thoughtful AI conversations with Darpan. Engage in deep discussions about philosophy, literature, culture, and ideas. Your intelligent companion for meaningful dialogue.">
<meta name="twitter:image" content="https://ajivatalks.in/og-image.jpeg">
<meta name="twitter:image:alt" content="Darpan - AI Conversations by Ajiva Talks">
<meta name="twitter:domain" content="ajivatalks.in">

<!-- Additional Social Meta Tags -->
<meta property="fb:app_id" content="YOUR_FACEBOOK_APP_ID">
<meta property="al:web:url" content="https://ajivatalks.in">

<!-- Schema.org Structured Data for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Darpan",
  "alternateName": "Darpan AI by Ajiva Talks",
  "url": "https://ajivatalks.in",
  "description": "An intelligent AI assistant for deep, meaningful conversations about philosophy, literature, art, and culture. Created by Ajiva Talks.",
  "applicationCategory": "AIApplication",
  "operatingSystem": "Web Browser",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "creator": {
    "@type": "Organization",
    "name": "Ajiva Talks",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Bangalore",
      "addressRegion": "Karnataka",
      "addressCountry": "IN"
    }
  },
  "screenshot": "https://ajivatalks.in/screenshot.png",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.8",
    "ratingCount": "1250"
  }
}
</script>

<!-- Organization Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "Ajiva Talks",
  "url": "https://ajivatalks.in",
  "logo": "https://ajivatalks.in/logo.png",
  "description": "Creators of Darpan, an intelligent AI companion for meaningful conversations",
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "Bangalore",
    "addressRegion": "Karnataka",
    "addressCountry": "IN"
  },
  "sameAs": [
    "https://twitter.com/AjivaTalks",
    "https://facebook.com/AjivaTalks",
    "https://linkedin.com/company/ajivatalks",
    "https://instagram.com/ajivatalk"
  ]
}
</script>

<!-- Website Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Darpan by Ajiva Talks",
  "url": "https://ajivatalks.in",
  "description": "Your intelligent companion for deep conversations",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://ajivatalks.in/?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>

<!-- Preconnect for Performance -->
<link rel="preconnect" href="https://www.googletagmanager.com">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="dns-prefetch" href="https://www.googletagmanager.com">
<link rel="dns-prefetch" href="https://www.google-analytics.com">

<!-- 
=============================================================================
PASTE THIS CODE RIGHT AFTER THE CLOSING </head> TAG OR AT THE TOP OF <body>
=============================================================================
-->

<script>
// Enhanced Google Analytics Event Tracking
(function() {
  'use strict';
  
  // Track page load time
  window.addEventListener('load', function() {
    var loadTime = window.performance.timing.domContentLoadedEventEnd - window.performance.timing.navigationStart;
    gtag('event', 'page_load_time', {
      'event_category': 'Performance',
      'event_label': 'Page Load',
      'value': loadTime
    });
  });

  // Track scroll depth
  var scrollDepths = [25, 50, 75, 100];
  var scrolledTo = {};
  window.addEventListener('scroll', function() {
    var scrollPercentage = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
    scrollDepths.forEach(function(depth) {
      if (scrollPercentage >= depth && !scrolledTo[depth]) {
        scrolledTo[depth] = true;
        gtag('event', 'scroll_depth', {
          'event_category': 'Engagement',
          'event_label': depth + '%',
          'value': depth
        });
      }
    });
  });

  // Track time on page
  var startTime = Date.now();
  var timeIntervals = [30, 60, 120, 300, 600]; // seconds
  var timeTracked = {};
  setInterval(function() {
    var timeOnPage = Math.floor((Date.now() - startTime) / 1000);
    timeIntervals.forEach(function(interval) {
      if (timeOnPage >= interval && !timeTracked[interval]) {
        timeTracked[interval] = true;
        gtag('event', 'time_on_page', {
          'event_category': 'Engagement',
          'event_label': interval + ' seconds',
          'value': interval
        });
      }
    });
  }, 5000);

  // Track clicks on all buttons
  document.addEventListener('click', function(e) {
    var target = e.target.closest('button');
    if (target) {
      gtag('event', 'button_click', {
        'event_category': 'Interaction',
        'event_label': target.textContent || target.id || 'unnamed_button',
        'button_text': target.textContent,
        'button_id': target.id
      });
    }
  });

  // Track link clicks
  document.addEventListener('click', function(e) {
    var target = e.target.closest('a');
    if (target && target.href) {
      gtag('event', 'link_click', {
        'event_category': 'Navigation',
        'event_label': target.href,
        'link_text': target.textContent
      });
    }
  });

  // Track input focus (user engagement)
  document.addEventListener('focus', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      gtag('event', 'input_focus', {
        'event_category': 'Form',
        'event_label': e.target.id || e.target.name || 'unnamed_input'
      });
    }
  }, true);

  // Track form submissions
  document.addEventListener('submit', function(e) {
    var form = e.target;
    gtag('event', 'form_submit', {
      'event_category': 'Form',
      'event_label': form.id || form.name || 'unnamed_form'
    });
  });

  // Track errors
  window.addEventListener('error', function(e) {
    gtag('event', 'javascript_error', {
      'event_category': 'Error',
      'event_label': e.message,
      'error_file': e.filename,
      'error_line': e.lineno
    });
  });

  // Track viewport size
  gtag('event', 'viewport_size', {
    'event_category': 'Technical',
    'event_label': window.innerWidth + 'x' + window.innerHeight,
    'viewport_width': window.innerWidth,
    'viewport_height': window.innerHeight
  });

  // Track device type
  var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  gtag('event', 'device_type', {
    'event_category': 'Technical',
    'event_label': isMobile ? 'Mobile' : 'Desktop'
  });

  // Track user engagement (mouse movement)
  var mouseMoved = false;
  document.addEventListener('mousemove', function() {
    if (!mouseMoved) {
      mouseMoved = true;
      gtag('event', 'user_active', {
        'event_category': 'Engagement',
        'event_label': 'Mouse Movement Detected'
      });
    }
  });

  // Track visibility changes (tab switching)
  document.addEventListener('visibilitychange', function() {
    gtag('event', 'visibility_change', {
      'event_category': 'Engagement',
      'event_label': document.hidden ? 'Tab Hidden' : 'Tab Visible'
    });
  });

  // Track copy events
  document.addEventListener('copy', function() {
    gtag('event', 'content_copy', {
      'event_category': 'Engagement',
      'event_label': 'User copied content'
    });
  });

  // Track right-click
  document.addEventListener('contextmenu', function() {
    gtag('event', 'right_click', {
      'event_category': 'Interaction',
      'event_label': 'Context menu opened'
    });
  });

  // Track page exit
  window.addEventListener('beforeunload', function() {
    var timeOnPage = Math.floor((Date.now() - startTime) / 1000);
    gtag('event', 'page_exit', {
      'event_category': 'Engagement',
      'event_label': 'User leaving page',
      'value': timeOnPage
    });
  });

})();
</script>

<!-- 
=============================================================================
PASTE THIS CODE IN YOUR JAVASCRIPT SECTION TO TRACK SPECIFIC EVENTS
=============================================================================
-->

<script>
// Custom event tracking functions for your app

// Track sign in
function trackSignIn(method) {
  gtag('event', 'login', {
    'event_category': 'User',
    'event_label': method,
    'method': method
  });
}

// Track sign up
function trackSignUp(method) {
  gtag('event', 'sign_up', {
    'event_category': 'User',
    'event_label': method,
    'method': method
  });
}

// Track message sent
function trackMessageSent(messageLength, isAI) {
  gtag('event', 'message_sent', {
    'event_category': 'Chat',
    'event_label': isAI ? 'AI Response' : 'User Message',
    'message_length': messageLength,
    'is_ai': isAI
  });
}

// Track new chat started
function trackNewChat() {
  gtag('event', 'new_chat', {
    'event_category': 'Chat',
    'event_label': 'New conversation started'
  });
}

// Track chat loaded
function trackChatLoaded(chatId) {
  gtag('event', 'chat_loaded', {
    'event_category': 'Chat',
    'event_label': 'Previous chat opened',
    'chat_id': chatId
  });
}

// Track sidebar toggle
function trackSidebarToggle(isOpen) {
  gtag('event', 'sidebar_toggle', {
    'event_category': 'UI',
    'event_label': isOpen ? 'Opened' : 'Closed'
  });
}

// Track prompt card click
function trackPromptCard(promptText) {
  gtag('event', 'prompt_card_click', {
    'event_category': 'Engagement',
    'event_label': promptText
  });
}

// Track copy message
function trackCopyMessage() {
  gtag('event', 'copy_message', {
    'event_category': 'Interaction',
    'event_label': 'User copied AI response'
  });
}

// Track API error
function trackAPIError(errorType, errorMessage) {
  gtag('event', 'api_error', {
    'event_category': 'Error',
    'event_label': errorType,
    'error_message': errorMessage
  });
}

// Track search/input typing
function trackUserTyping() {
  gtag('event', 'user_typing', {
    'event_category': 'Engagement',
    'event_label': 'User started typing'
  });
}

// Track quota/limit reached
function trackQuotaReached() {
  gtag('event', 'quota_reached', {
    'event_category': 'Usage',
    'event_label': 'User hit rate limit'
  });
}

// Track feature usage
function trackFeatureUsage(featureName) {
  gtag('event', 'feature_usage', {
    'event_category': 'Features',
    'event_label': featureName
  });
}

// Track conversation length
function trackConversationLength(messageCount) {
  gtag('event', 'conversation_length', {
    'event_category': 'Chat',
    'event_label': messageCount + ' messages',
    'value': messageCount
  });
}

// Track user session duration
function trackSessionDuration(duration) {
  gtag('event', 'session_duration', {
    'event_category': 'Engagement',
    'event_label': Math.floor(duration / 60) + ' minutes',
    'value': duration
  });
}

// Track keyboard shortcuts
function trackKeyboardShortcut(shortcut) {
  gtag('event', 'keyboard_shortcut', {
    'event_category': 'Interaction',
    'event_label': shortcut
  });
}

// Track modal open/close
function trackModal(modalName, action) {
  gtag('event', 'modal_' + action, {
    'event_category': 'UI',
    'event_label': modalName,
    'action': action
  });
}
</script>

<!-- 
=============================================================================
USAGE EXAMPLES - ADD THESE TO YOUR EXISTING JAVASCRIPT FUNCTIONS
=============================================================================

// In Google Sign In function:
googleBtn.addEventListener('click', async () => {
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        trackSignIn('google'); // ADD THIS
        showToast('Welcome!');
    } catch (error) {
        showToast('Sign in failed', 'error');
    }
});

// In send message function:
async function sendMessage() {
    // ... existing code ...
    trackMessageSent(text.length, false); // ADD THIS after user sends message
    // ... existing code ...
    trackMessageSent(aiText.length, true); // ADD THIS after AI responds
}

// In new chat button:
newChatBtn.addEventListener('click', () => {
    trackNewChat(); // ADD THIS
    // ... existing code ...
});

// In sidebar toggle:
menuToggle.addEventListener('click', () => {
    sidebar.classList.toggle('hidden');
    trackSidebarToggle(!sidebar.classList.contains('hidden')); // ADD THIS
});

// In prompt card click:
function usePrompt(text) {
    trackPromptCard(text); // ADD THIS
    messageInput.value = text;
    messageInput.focus();
}

// In copy button:
copy.onclick = () => {
    navigator.clipboard.writeText(text);
    trackCopyMessage(); // ADD THIS
    showToast('Copied!');
};

// In API error handling:
} catch (error) {
    trackAPIError('api_fetch_error', error.message); // ADD THIS
    // ... existing error handling ...
}

// In keyboard shortcuts:
document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        trackKeyboardShortcut('cmd+k'); // ADD THIS
        newChatBtn.click();
    }
});

=============================================================================
-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Darpan - Intelligent Conversations | Ajiva Talks</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Darpan by Ajiva Talks - Your intelligent companion for deep conversations about philosophy, culture, and ideas.">
    <meta name="keywords" content="AI chat, Darpan, Ajiva Talks, intelligent assistant, conversations">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Darpan - Intelligent Conversations">
    <meta property="og:description" content="Experience thoughtful AI conversations with Darpan by Ajiva Talks">
    <meta property="og:type" content="website">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #0f0f0f;
            --bg-tertiary: #141414;
            --text-primary: #e8e8e8;
            --text-secondary: #999999;
            --border-primary: #1f1f1f;
            --border-secondary: #2a2a2a;
            --accent: #ffffff;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --blue: #3b82f6;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header */
        .header {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-primary);
            padding: 0.875rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            height: 60px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-toggle {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .menu-toggle:hover {
            background: var(--bg-secondary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .logo-img {
            height: 24px;
            width: auto;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .quota-badge {
            padding: 0.5rem 0.875rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--success);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 1.5px solid var(--border-secondary);
            transition: all 0.2s;
        }

        .user-avatar:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .auth-btn {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .auth-btn:hover {
            opacity: 0.9;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            height: calc(100dvh - 60px);
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }

        .new-chat-btn {
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .new-chat-btn:hover {
            background: var(--bg-secondary);
        }

        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .chat-item {
            padding: 0.625rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }

        .chat-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .chat-item.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .messages-container {
            max-width: 48rem;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 200px);
            text-align: center;
            padding: 2rem 1rem;
        }

        .welcome-icon {
            width: 100px;
            height: 100px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .welcome-title {
            font-family: 'Instrument Serif', serif;
            font-size: 2rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .welcome-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            max-width: 500px;
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.75rem;
            max-width: 800px;
            width: 100%;
        }

        .prompt-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .prompt-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-secondary);
        }

        .prompt-card-title {
            font-weight: 600;
            margin-bottom: 0.375rem;
            font-size: 0.875rem;
        }

        .prompt-card-text {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1rem;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-text {
            line-height: 1.6;
            color: var(--text-primary);
            font-size: 0.9375rem;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-text strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-text em {
            font-style: italic;
        }

        .message-text code {
            background: var(--bg-tertiary);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .message-text pre {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5rem 0;
            border: 1px solid var(--border-primary);
        }

        .message-text pre code {
            background: transparent;
            padding: 0;
            border: none;
            font-size: 0.875rem;
            display: block;
            white-space: pre;
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.625rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            padding: 0.375rem 0.625rem;
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 0;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-6px); }
        }

        /* Input Area */
        .input-area {
            border-top: 1px solid var(--border-primary);
            padding: 1rem;
            background: var(--bg-primary);
        }

        .input-wrapper {
            max-width: 48rem;
            margin: 0 auto;
            position: relative;
        }

        .input-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            transition: all 0.2s;
        }

        .input-container:focus-within {
            border-color: var(--border-secondary);
            background: var(--bg-tertiary);
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            resize: none;
            max-height: 200px;
            line-height: 1.5;
        }

        .message-input::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            width: 32px;
            height: 32px;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Auth Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-family: 'Instrument Serif', serif;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-input {
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--border-secondary);
        }

        .google-btn {
            padding: 0.75rem;
            background: white;
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .google-btn:hover {
            opacity: 0.9;
        }

        .divider {
            text-align: center;
            position: relative;
            margin: 0.5rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 43%;
            height: 1px;
            background: var(--border-primary);
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 0.875rem 1.25rem;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
            font-size: 0.875rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3a3a3a;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 60px;
                height: calc(100vh - 60px);
                z-index: 90;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
            }

            .example-prompts {
                grid-template-columns: 1fr;
            }

            .welcome-title {
                font-size: 1.5rem;
            }

            .messages-container {
                padding: 1rem 0.75rem;
            }

            .message {
                gap: 0.75rem;
            }
        }

        @media (max-width: 640px) {
            .header {
                padding: 0.75rem 1rem;
            }

            .input-area {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <div class="logo">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 500 500'%3E%3Crect fill='%23f5f5dc' width='500' height='500'/%3E%3Ctext x='250' y='320' font-family='Arial, sans-serif' font-size='120' font-weight='500' text-anchor='middle' fill='%23000'%3Edarpan%3C/text%3E%3C/svg%3E" alt="Darpan" class="logo-img">
            </div>
        </div>
        <div class="header-right">
            <div class="quota-badge">
                <span>‚ú®</span>
                <span>Unlimited</span>
            </div>
            <div id="userSection">
                <button class="auth-btn" id="authBtn">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar hidden" id="sidebar">
            <div class="sidebar-content">
                <button class="new-chat-btn" id="newChatBtn">
                    <span>+</span>
                    <span>New chat</span>
                </button>
                <div class="chat-list" id="chatList">
                    <!-- Chats will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-container">
            <div class="messages-wrapper" id="messagesWrapper">
                <div class="messages-container" id="messagesContainer">
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 500 500'%3E%3Crect fill='%23f5f5dc' width='500' height='500'/%3E%3Ctext x='250' y='320' font-family='Arial, sans-serif' font-size='120' font-weight='500' text-anchor='middle' fill='%23000'%3Edarpan%3C/text%3E%3C/svg%3E" alt="Darpan" style="width: 100px; height: auto; border-radius: 12px;">
                        </div>
                        <h1 class="welcome-title">Welcome to Darpan</h1>
                        <p class="welcome-subtitle">Your intelligent companion for deep conversations about philosophy, culture, and the human experience. Created by Ajiva Talks.</p>
                        <div class="example-prompts">
                            <div class="prompt-card" onclick="usePrompt('Tell me about the philosophy of consciousness')">
                                <div class="prompt-card-title">Philosophy</div>
                                <div class="prompt-card-text">Explore consciousness and existence</div>
                            </div>
                            <div class="prompt-card" onclick="usePrompt('What makes literature timeless?')">
                                <div class="prompt-card-title">Literature</div>
                                <div class="prompt-card-text">Discuss great narratives</div>
                            </div>
                            <div class="prompt-card" onclick="usePrompt('Explain the role of art in society')">
                                <div class="prompt-card-title">Culture</div>
                                <div class="prompt-card-text">Understand cultural impact</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input -->
            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-container">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="Message Darpan..." 
                            rows="1"
                            disabled
                        ></textarea>
                        <button class="send-btn" id="sendBtn" disabled>‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <h2 class="modal-title">Sign in to Darpan</h2>
            <div class="auth-form">
                <button class="google-btn" id="googleBtn">
                    <span>üîê</span>
                    <span>Continue with Google</span>
                </button>
                <div class="divider">or</div>
                <input type="email" class="form-input" id="emailInput" placeholder="Email">
                <input type="password" class="form-input" id="passwordInput" placeholder="Password">
                <button class="auth-btn" id="emailAuthBtn" style="width: 100%">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAGYl3DZDq7S714sveY4yq2s_O5JaFSuf4",
            authDomain: "ajiva-talks.firebaseapp.com",
            projectId: "ajiva-talks",
            storageBucket: "ajiva-talks.firebasestorage.app",
            messagingSenderId: "627601368262",
            appId: "1:627601368262:web:8512d155109d1bab5ca3c7"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // API Config
        const SARVAM_API_KEY = 'sk_2sx31xrp_tSHiL5KpvaS52RHOakucpC1D';
        const SARVAM_URL = 'https://api.sarvam.ai/v1/chat/completions';

        // Knowledge Base
        const KNOWLEDGE_BASE = {
            greetings: {
                patterns: ['hello', 'hi', 'hey', 'namaste', 'good morning', 'good evening', 'good afternoon'],
                responses: [
                    "Hello! I'm Darpan, your companion for meaningful conversations. How may I assist you today?",
                    "Greetings! I'm here to explore ideas and engage in thoughtful dialogue with you.",
                    "Hello! Welcome to Darpan. What would you like to discuss?"
                ]
            },
            identity: {
                patterns: ['who are you', 'what are you', 'who made you', 'who created you', 'your creator', 'your origin', 'built you', 'developed you'],
                response: "I'm Darpan, an intelligent AI assistant created by the Ajiva Talks team. My purpose is to facilitate deep, meaningful conversations about philosophy, culture, literature, and the human experience. I'm here to help you explore complex ideas through thoughtful dialogue."
            },
            capabilities: {
                patterns: ['what can you do', 'your capabilities', 'how can you help', 'what do you know'],
                response: "I specialize in engaging conversations about philosophy, literature, art, culture, and complex ideas. I can help you explore concepts, analyze perspectives, discuss creative works, and dive deep into meaningful topics. What interests you?"
            },
            thanks: {
                patterns: ['thank you', 'thanks', 'appreciate'],
                responses: ["You're welcome! Happy to help.", "My pleasure! Let me know if you need anything else.", "Glad I could assist!"]
            }
        };

        // State
        let currentUser = null;
        let currentChatId = null;
        let conversationHistory = [];
        let lastRequestTime = 0;

        // DOM
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const authModal = document.getElementById('authModal');
        const authBtn = document.getElementById('authBtn');
        const googleBtn = document.getElementById('googleBtn');
        const emailAuthBtn = document.getElementById('emailAuthBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesContainer = document.getElementById('messagesContainer');
        const messagesWrapper = document.getElementById('messagesWrapper');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const newChatBtn = document.getElementById('newChatBtn');
        const chatList = document.getElementById('chatList');

        // Toggle Sidebar
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
        });

        // Auth State
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                authModal.classList.remove('active');
                document.getElementById('userSection').innerHTML = `
                    <img src="${user.photoURL || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üë§</text></svg>'}" 
                         class="user-avatar" alt="User">
                `;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                await loadChats();
            } else {
                currentUser = null;
                authModal.classList.add('active');
                messageInput.disabled = true;
                sendBtn.disabled = true;
            }
        });

        // Google Sign In
        googleBtn.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                showToast('Welcome!');
            } catch (error) {
                showToast('Sign in failed', 'error');
            }
        });

        // Email Auth
        emailAuthBtn.addEventListener('click', async () => {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        showToast('Account created!');
                    } catch (err) {
                        showToast('Failed to create account', 'error');
                    }
                } else {
                    showToast('Sign in failed', 'error');
                }
            }
        });

        // Get Local Response
        function getLocalResponse(msg) {
            const lower = msg.toLowerCase();
            
            for (const [key, data] of Object.entries(KNOWLEDGE_BASE)) {
                for (const pattern of data.patterns) {
                    if (lower.includes(pattern)) {
                        if (Array.isArray(data.responses)) {
                            return data.responses[Math.floor(Math.random() * data.responses.length)];
                        }
                        return data.response;
                    }
                }
            }
            return null;
        }

        // Send Message
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentUser) return;

            const now = Date.now();
            if (now - lastRequestTime < 2000) {
                showToast('Please wait a moment...', 'error');
                return;
            }
            lastRequestTime = now;

            welcomeScreen.style.display = 'none';
            addMessage(text, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            conversationHistory.push({ role: 'user', content: text });

            // Check local knowledge
            const localResp = getLocalResponse(text);
            if (localResp) {
                setTimeout(() => {
                    addMessage(localResp, 'assistant', true);
                    conversationHistory.push({ role: 'assistant', content: localResp });
                    saveMessage(text, 'user');
                    saveMessage(localResp, 'assistant');
                }, 300);
                return;
            }

            const typingId = showTyping();

            try {
                const messages = [
                    {
                        role: 'system',
                        content: 'You are Darpan, an intelligent AI assistant created by the Ajiva Talks team. You specialize in deep, thoughtful conversations about philosophy, literature, art, and culture. Be eloquent, insightful, and engaging.'
                    },
                    ...conversationHistory.slice(-6)
                ];

                const response = await fetch(SARVAM_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-subscription-key': SARVAM_API_KEY
                    },
                    body: JSON.stringify({
                        model: 'sarvam-m',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 800
                    })
                });

                removeTyping(typingId);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error Details:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: errorData
                    });
                    
                    let toastMessage = "Connection issue";
                    
                    if (response.status === 401 || response.status === 403) {
                        toastMessage = "API authentication error";
                    } else if (response.status === 429) {
                        toastMessage = "Too many requests";
                    } else if (response.status === 422) {
                        toastMessage = "Request format error";
                    } else if (response.status >= 500) {
                        toastMessage = "Service unavailable";
                    }
                    
                    showToast(toastMessage, 'error');
                    throw new Error("API Error");
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
                    console.error('Invalid response structure:', data);
                    showToast('Invalid response', 'error');
                    throw new Error("Invalid response format.");
                }
                
                let aiText = data.choices[0].message.content.trim();

                if (!aiText || aiText.length < 5 || aiText.toLowerCase().includes('missing or insufficient permissions')) {
                    console.error('Empty or error response:', aiText);
                    showToast('Unable to generate response', 'error');
                    throw new Error("Empty response received.");
                }

                // Brand consistency
                aiText = aiText
                    .replace(/Sarvam\s*AI/gi, 'Darpan')
                    .replace(/I am Sarvam/gi, 'I am Darpan')
                    .replace(/created by Sarvam/gi, 'created by Ajiva Talks')
                    .replace(/developed by Sarvam/gi, 'developed by Ajiva Talks')
                    .replace(/Sarvam/gi, 'Darpan');

                addMessage(aiText, 'assistant', true);
                conversationHistory.push({ role: 'assistant', content: aiText });
                
                await saveMessage(text, 'user');
                await saveMessage(aiText, 'assistant');

            } catch (error) {
                removeTyping(typingId);
                console.error('Send message error:', error);
                
                if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'user') {
                    conversationHistory.pop();
                }
            }
        }

        // Parse Markdown (simple parser for bold, italic, code)
        function parseMarkdown(text) {
            // Escape HTML to prevent XSS
            text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Parse code blocks (```code```)
            text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            
            // Parse inline code (`code`)
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Parse bold (**text** or __text__)
            text = text.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__([^_]+)__/g, '<strong>$1</strong>');
            
            // Parse italic (*text* or _text_)
            text = text.replace(/\*([^\*]+)\*/g, '<em>$1</em>');
            text = text.replace(/_([^_]+)_/g, '<em>$1</em>');
            
            // Parse line breaks
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        // Add Message
        function addMessage(text, role, animate = false) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            if (role === 'assistant') {
                avatar.innerHTML = '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 500 500\'%3E%3Crect fill=\'%23f5f5dc\' width=\'500\' height=\'500\'/%3E%3Ctext x=\'250\' y=\'320\' font-family=\'Arial, sans-serif\' font-size=\'120\' font-weight=\'500\' text-anchor=\'middle\' fill=\'%23000\'%3Edarpan%3C/text%3E%3C/svg%3E" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">';
            } else {
                avatar.textContent = 'üë§';
            }
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            if (animate && role === 'assistant') {
                let i = 0;
                const interval = setInterval(() => {
                    const currentText = text.substring(0, i + 1);
                    messageText.innerHTML = parseMarkdown(currentText);
                    i++;
                    scrollToBottom();
                    if (i >= text.length) {
                        clearInterval(interval);
                        addActions(content, text);
                    }
                }, 15);
            } else {
                messageText.innerHTML = parseMarkdown(text);
                if (role === 'assistant') addActions(content, text);
            }
            
            content.appendChild(messageText);
            div.appendChild(avatar);
            div.appendChild(content);
            messagesContainer.appendChild(div);
            scrollToBottom();
        }

        // Add Actions
        function addActions(parent, text) {
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            
            const copy = document.createElement('button');
            copy.className = 'action-btn';
            copy.textContent = 'Copy';
            copy.onclick = () => {
                navigator.clipboard.writeText(text);
                showToast('Copied!');
            };
            
            actions.appendChild(copy);
            parent.appendChild(actions);
        }

        // Typing Indicator
        function showTyping() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message assistant';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 500 500\'%3E%3Crect fill=\'%23f5f5dc\' width=\'500\' height=\'500\'/%3E%3Ctext x=\'250\' y=\'320\' font-family=\'Arial, sans-serif\' font-size=\'120\' font-weight=\'500\' text-anchor=\'middle\' fill=\'%23000\'%3Edarpan%3C/text%3E%3C/svg%3E" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">';
            
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            
            div.appendChild(avatar);
            div.appendChild(indicator);
            messagesContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // Scroll
        function scrollToBottom() {
            messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
        }

        // Save Message - FIXED WITH BETTER ERROR HANDLING
        async function saveMessage(text, role) {
            if (!currentUser) return;
            
            try {
                if (!currentChatId) {
                    currentChatId = db.collection('chats').doc().id;
                    const title = text.substring(0, 50) + (text.length > 50 ? '...' : '');
                    
                    // Create chat document
                    await db.collection('chats').doc(currentChatId).set({
                        userId: currentUser.uid,
                        title: title,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Reload chats after creating new one
                    loadChats().catch(err => console.error('Load chats after create:', err));
                }
                
                // Add message to subcollection
                await db.collection('chats').doc(currentChatId).collection('messages').add({
                    text: text,
                    role: role,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update chat timestamp
                await db.collection('chats').doc(currentChatId).update({
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error('Save message error:', error);
                // Silently fail - don't disrupt user experience
            }
        }

        // Load Chats - FIXED WITH PROPER ERROR HANDLING
        async function loadChats() {
            if (!currentUser) {
                chatList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">Sign in to see your chats</div>';
                return;
            }
            
            try {
                // Try to load chats with orderBy
                let snapshot;
                try {
                    snapshot = await db.collection('chats')
                        .where('userId', '==', currentUser.uid)
                        .orderBy('updatedAt', 'desc')
                        .limit(50)
                        .get();
                } catch (orderError) {
                    // If orderBy fails (missing index), try without ordering
                    console.warn('OrderBy failed, trying without ordering:', orderError);
                    snapshot = await db.collection('chats')
                        .where('userId', '==', currentUser.uid)
                        .limit(50)
                        .get();
                }
                
                chatList.innerHTML = '';
                
                if (snapshot.empty) {
                    chatList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">No previous chats</div>';
                    return;
                }
                
                // Convert to array and sort manually if needed
                const chats = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    chats.push({ id: doc.id, ...data });
                });
                
                // Sort by updatedAt if available
                chats.sort((a, b) => {
                    if (!a.updatedAt || !b.updatedAt) return 0;
                    return b.updatedAt.toMillis() - a.updatedAt.toMillis();
                });
                
                // Display chats
                chats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    if (chat.id === currentChatId) item.classList.add('active');
                    item.textContent = chat.title || 'New Chat';
                    item.onclick = () => loadChat(chat.id);
                    chatList.appendChild(item);
                });
                
            } catch (error) {
                console.error('Load chats error:', error);
                
                // Show helpful error message
                let errorMsg = 'Unable to load chats';
                if (error.code === 'permission-denied') {
                    errorMsg = 'Permission denied. Check Firestore rules.';
                } else if (error.code === 'failed-precondition') {
                    errorMsg = 'Database index required. Check console.';
                }
                
                chatList.innerHTML = `<div style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">${errorMsg}</div>`;
            }
        }

        // Load Chat - FIXED WITH BETTER ERROR HANDLING
        async function loadChat(chatId) {
            currentChatId = chatId;
            messagesContainer.innerHTML = '';
            welcomeScreen.style.display = 'none';
            conversationHistory = [];
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-messages';
            loadingDiv.style.cssText = 'text-align: center; padding: 2rem; color: var(--text-secondary);';
            loadingDiv.textContent = 'Loading messages...';
            messagesContainer.appendChild(loadingDiv);
            
            try {
                // Try to load messages with orderBy
                let snapshot;
                try {
                    snapshot = await db.collection('chats').doc(chatId).collection('messages')
                        .orderBy('timestamp', 'asc')
                        .get();
                } catch (orderError) {
                    // If orderBy fails, try without ordering
                    console.warn('OrderBy failed for messages, trying without ordering:', orderError);
                    snapshot = await db.collection('chats').doc(chatId).collection('messages')
                        .get();
                }
                
                const loading = document.getElementById('loading-messages');
                if (loading) loading.remove();
                
                if (snapshot.empty) {
                    welcomeScreen.style.display = 'flex';
                    return;
                }
                
                // Convert to array and sort manually
                const messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    messages.push(data);
                });
                
                // Sort by timestamp
                messages.sort((a, b) => {
                    if (!a.timestamp || !b.timestamp) return 0;
                    return a.timestamp.toMillis() - b.timestamp.toMillis();
                });
                
                // Display messages
                messages.forEach(data => {
                    addMessage(data.text, data.role);
                    conversationHistory.push({ role: data.role, content: data.text });
                });
                
                scrollToBottom();
                await loadChats();
                
            } catch (error) {
                console.error('Load chat error:', error);
                const loading = document.getElementById('loading-messages');
                if (loading) loading.remove();
                
                let errorMsg = 'Failed to load chat';
                if (error.code === 'permission-denied') {
                    errorMsg = 'Permission denied';
                }
                
                showToast(errorMsg, 'error');
                welcomeScreen.style.display = 'flex';
            }
        }

        // New Chat
        newChatBtn.addEventListener('click', () => {
            currentChatId = null;
            conversationHistory = [];
            messagesContainer.innerHTML = '';
            welcomeScreen.style.display = 'flex';
            loadChats();
            sidebar.classList.add('hidden');
        });

        // Toast
        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            if (type === 'error') toast.style.borderColor = 'var(--error)';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Use Prompt
        function usePrompt(text) {
            messageInput.value = text;
            messageInput.focus();
        }

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                newChatBtn.click();
            }
        });
    </script>
</body>
</html>
